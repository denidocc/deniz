{% extends "admin/base.html" %}

{% block page_title %}Все заказы{% endblock %}

{% block extra_css %}
<style>
    .filters-section {
        background: var(--admin-light);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .orders-table {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .order-status {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
        text-align: center;
        min-width: 100px;
    }
    
    .status-pending { background-color: #28a745; color: white; }
    .status-confirmed { background-color: #ffc107; color: black; }
    .status-completed { background-color: #6c757d; color: white; }
    .status-cancelled { background-color: #dc3545; color: white; }
    
    .pagination-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: var(--admin-light);
        border-radius: 8px;
        margin-top: 1rem;
    }
    
    .loading-placeholder {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }
    
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-list-ul"></i> Все заказы</h2>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-success" onclick="exportOrders('excel')">
            <i class="bi bi-file-earmark-excel"></i> Excel
        </button>
        <button class="btn btn-outline-danger" onclick="exportOrders('pdf')">
            <i class="bi bi-file-earmark-pdf"></i> PDF
        </button>
    </div>
</div>

<!-- Filters Section -->
<div class="filters-section">
    <h5 class="mb-3"><i class="bi bi-funnel"></i> Фильтры</h5>
    <div class="row">
        <div class="col-md-2">
            <label for="statusFilter" class="form-label">Статус</label>
            <select class="form-select" id="statusFilter">
                <option value="">Все статусы</option>
                <option value="pending">Новые</option>
                <option value="confirmed">Подтвержденные</option>
                <option value="completed">Завершенные</option>
                <option value="cancelled">Отмененные</option>
            </select>
        </div>
        <div class="col-md-2">
            <label for="tableFilter" class="form-label">Стол</label>
            <select class="form-select" id="tableFilter">
                <option value="">Все столы</option>
            </select>
        </div>
        <div class="col-md-2">
            <label for="waiterFilter" class="form-label">Официант</label>
            <select class="form-select" id="waiterFilter">
                <option value="">Все официанты</option>
            </select>
        </div>
        <div class="col-md-2">
            <label for="startDate" class="form-label">Дата начала</label>
            <input type="date" class="form-control" id="startDate">
        </div>
        <div class="col-md-2">
            <label for="endDate" class="form-label">Дата окончания</label>
            <input type="date" class="form-control" id="endDate">
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button class="btn btn-primary w-100" onclick="applyFilters()">
                <i class="bi bi-search"></i> Применить
            </button>
        </div>
    </div>
</div>

<!-- Orders Table -->
<div class="orders-table">
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Стол</th>
                    <th>Гостей</th>
                    <th>Статус</th>
                    <th>Сумма</th>
                    <th>Официант</th>
                    <th>Позиций</th>
                    <th>Дата создания</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody id="ordersTableBody">
                <tr>
                    <td colspan="9" class="text-center py-4">
                        <div class="loading-placeholder">
                            <div class="spinner"></div>
                            <p>Загрузка заказов...</p>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
<div class="pagination-info">
    <div class="pagination-controls">
        <button class="btn btn-outline-primary btn-sm" onclick="changePage(-1)" id="prevBtn" disabled>
            <i class="bi bi-chevron-left"></i> Назад
        </button>
        <span class="mx-3" id="pageInfo">Страница 1 из 1</span>
        <button class="btn btn-outline-primary btn-sm" onclick="changePage(1)" id="nextBtn" disabled>
            Вперед <i class="bi bi-chevron-right"></i>
        </button>
    </div>
    <div class="pagination-size">
        <label for="perPageSelect" class="form-label me-2">Показать:</label>
        <select class="form-select form-select-sm" id="perPageSelect" style="width: auto;">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
            <option value="100">100</option>
        </select>
    </div>
</div>

<!-- Модальное окно для просмотра деталей заказа -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orderDetailsModalLabel">Детали заказа #<span id="orderDetailsNumber"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Контент будет загружен динамически -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentPage = 1;
    let currentFilters = {};
    
    document.addEventListener('DOMContentLoaded', function() {
        // Устанавливаем даты по умолчанию (последние 30 дней)
        const today = new Date();
        const monthAgo = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
        
        document.getElementById('startDate').value = monthAgo.toISOString().split('T')[0];
        document.getElementById('endDate').value = today.toISOString().split('T')[0];
        
        // Загружаем справочники для фильтров
        loadFilterOptions();
        
        // Загружаем заказы
        loadOrders();
        
        // Обработчики событий
        document.getElementById('perPageSelect').addEventListener('change', function() {
            currentPage = 1;
            loadOrders();
        });
    });
    
    async function loadFilterOptions() {
        try {
            // Загружаем столы
            const tablesResponse = await fetch('/admin/api/tables/filters');
            if (tablesResponse.ok) {
                const tablesData = await tablesResponse.json();
                const tableSelect = document.getElementById('tableFilter');
                tablesData.data.forEach(table => {
                    const option = document.createElement('option');
                    option.value = table.id;
                    option.textContent = `Стол ${table.table_number}`;
                    tableSelect.appendChild(option);
                });
            }
            
            // Загружаем официантов
            const waitersResponse = await fetch('/admin/api/waiters');
            if (waitersResponse.ok) {
                const waitersData = await waitersResponse.json();
                const waiterSelect = document.getElementById('waiterFilter');
                waitersData.data.forEach(waiter => {
                    const option = document.createElement('option');
                    option.value = waiter.id;
                    option.textContent = waiter.username;
                    waiterSelect.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading filter options:', error);
        }
    }
    
    async function loadOrders() {
        try {
            const tableBody = document.getElementById('ordersTableBody');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center py-4">
                        <div class="loading-placeholder">
                            <div class="spinner"></div>
                            <p>Загрузка заказов...</p>
                        </div>
                    </td>
                </tr>
            `;
            
            // Формируем параметры запроса
            const params = new URLSearchParams({
                page: currentPage,
                per_page: document.getElementById('perPageSelect').value,
                ...currentFilters
            });
            
            const response = await fetch(`/admin/api/orders?${params}`);
            const data = await response.json();
            
            if (data.status === 'success') {
                displayOrders(data.data.orders);
                updatePagination(data.data.pagination);
            } else {
                throw new Error(data.message);
            }
        } catch (error) {
            console.error('Error loading orders:', error);
            document.getElementById('ordersTableBody').innerHTML = `
                <tr>
                    <td colspan="9" class="text-center py-4 text-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        <p>Ошибка загрузки заказов: ${error.message}</p>
                    </td>
                </tr>
            `;
        }
    }
    
    function displayOrders(orders) {
        const tableBody = document.getElementById('ordersTableBody');
        
        if (orders.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center py-4 text-muted">
                        <i class="bi bi-inbox"></i>
                        <p>Заказы не найдены</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        tableBody.innerHTML = orders.map(order => `
            <tr>
                <td><strong>#${order.id}</strong></td>
                <td>${order.table_number}</td>
                <td>${order.guest_count}</td>
                <td>
                    <span class="order-status status-${order.status}">
                        ${getStatusDisplayName(order.status)}
                    </span>
                </td>
                <td><strong>${order.total_amount.toFixed(2)} TMT</strong></td>
                <td>${order.waiter_name}</td>
                <td>${order.items_count}</td>
                <td>${new Date(order.created_at).toLocaleString('ru-RU')}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="viewOrderDetails(${order.id})">
                        <i class="bi bi-eye"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }
    
    function getStatusDisplayName(status) {
        const statusNames = {
            'pending': 'Новый',
            'confirmed': 'Подтвержден',
            'completed': 'Завершен',
            'cancelled': 'Отменен'
        };
        return statusNames[status] || status;
    }
    
    function updatePagination(pagination) {
        document.getElementById('pageInfo').textContent = `Страница ${pagination.page} из ${pagination.pages}`;
        document.getElementById('prevBtn').disabled = !pagination.has_prev;
        document.getElementById('nextBtn').disabled = !pagination.has_next;
    }
    
    function changePage(delta) {
        currentPage += delta;
        if (currentPage < 1) currentPage = 1;
        loadOrders();
    }
    
    function applyFilters() {
        currentFilters = {
            status: document.getElementById('statusFilter').value,
            table_id: document.getElementById('tableFilter').value,
            waiter_id: document.getElementById('waiterFilter').value,
            start_date: document.getElementById('startDate').value,
            end_date: document.getElementById('endDate').value
        };
        
        // Убираем пустые значения
        Object.keys(currentFilters).forEach(key => {
            if (!currentFilters[key]) delete currentFilters[key];
        });
        
        currentPage = 1;
        loadOrders();
    }
    
    function viewOrderDetails(orderId) {
        console.log('Загрузка деталей заказа:', orderId);
        
        // Показываем индикатор загрузки
        const modal = document.getElementById('orderDetailsModal');
        const modalBody = modal.querySelector('.modal-body');
        const modalTitle = modal.querySelector('#orderDetailsModalLabel');
        
        // Обновляем заголовок с номером заказа
        modalTitle.innerHTML = `Детали заказа #${orderId}`;
        
        modalBody.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Загрузка...</span></div></div>';
        
        // Открываем модальное окно
        const bootstrapModal = new bootstrap.Modal(modal);
        bootstrapModal.show();
        
        // Загружаем детали заказа
        fetch(`/admin/api/orders/${orderId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Получены данные заказа:', data);
                if (data.status === 'success') {
                    // Заменяем весь контент модального окна
                    modalBody.innerHTML = generateOrderDetailsHTML(data.data);
                } else {
                    throw new Error(data.message || 'Неизвестная ошибка');
                }
            })
            .catch(error => {
                console.error('Ошибка загрузки деталей заказа:', error);
                modalBody.innerHTML = `
                    <div class="alert alert-danger">
                        <h6>Ошибка загрузки</h6>
                        <p>Не удалось загрузить детали заказа: ${error.message}</p>
                    </div>
                `;
            });
    }

    // Функция для генерации HTML деталей заказа
    function generateOrderDetailsHTML(order) {
        console.log('Структура заказа для отображения:', order);
        console.log('Структура items:', order.items);
        
        const bonusCardHTML = order.bonus_card_info ? `
            <strong>Номер карты:</strong> ${order.bonus_card_info.card_number}<br>
            <strong>Владелец:</strong> ${order.bonus_card_info.first_name} ${order.bonus_card_info.last_name}<br>
            <strong>Скидка:</strong> ${order.bonus_card_info.discount_percent}%
        ` : '<em>Бонусная карта не использовалась</em>';

        // Безопасная генерация HTML для позиций заказа
        let itemsHTML = '';
        if (order.items && Array.isArray(order.items)) {
            itemsHTML = order.items.map(item => {
                console.log('Обработка item:', item);
                // Исправляем: используем правильные поля из данных
                const itemName = item.menu_item_name || 'Неизвестное блюдо';
                const quantity = item.quantity || 1;
                const price = item.unit_price || 0;
                const totalPrice = item.total_price || 0;
                
                return `
                    <tr>
                        <td>${itemName}</td>
                        <td>${quantity}</td>
                        <td>${price} TMT</td>
                        <td>${totalPrice} TMT</td>
                    </tr>
                `;
            }).join('');
        } else {
            itemsHTML = '<tr><td colspan="4" class="text-center">Позиции заказа не найдены</td></tr>';
        }

        return `
            <div class="row">
                <div class="col-md-6">
                    <h6>Основная информация</h6>
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Стол:</strong></td>
                            <td>${order.table_number || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td><strong>Гостей:</strong></td>
                            <td>${order.guest_count || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td><strong>Статус:</strong></td>
                            <td>${order.status || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td><strong>Создан:</strong></td>
                            <td>${order.created_at ? new Date(order.created_at).toLocaleString('ru-RU') : 'N/A'}</td>
                        </tr>
                        <tr>
                            <td><strong>Официант:</strong></td>
                            <td>${order.waiter_name || 'N/A'}</td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6>Финансовая информация</h6>
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Подытог:</strong></td>
                            <td>${order.subtotal || 0} TMT</td>
                        </tr>
                        <tr>
                            <td><strong>Сервисный сбор:</strong></td>
                            <td>${order.service_charge || 0} TMT</td>
                        </tr>
                        <tr>
                            <td><strong>Скидка:</strong></td>
                            <td>${order.discount_amount || 0} TMT</td>
                        </tr>
                        <tr class="table-active">
                            <td><strong>ИТОГО:</strong></td>
                            <td>${order.total_amount || 0} TMT</td>
                        </tr>
                    </table>
                    
                    <h6 class="mt-3">Бонусная карта</h6>
                    <div>${bonusCardHTML}</div>
                </div>
            </div>
            
            <h6 class="mt-4">Позиции заказа</h6>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Блюдо</th>
                            <th>Количество</th>
                            <th>Цена</th>
                            <th>Сумма</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHTML}
                    </tbody>
                </table>
            </div>
        `;
    }

    // Функция форматирования валюты
    function formatCurrency(amount) {
        return new Intl.NumberFormat('ru-RU', {
            style: 'currency',
            currency: 'TMT',
            minimumFractionDigits: 2
        }).format(amount);
    }

    // Функция получения класса для статуса
    function getStatusClass(status) {
        const statusClasses = {
            'pending': 'bg-warning',
            'confirmed': 'bg-info',
            'active': 'bg-primary',
            'completed': 'bg-success',
            'cancelled': 'bg-danger'
        };
        return statusClasses[status] || 'bg-secondary';
    }
    
    function showError(message) {
        // Показываем ошибку в модальном окне или как уведомление
        if (document.getElementById('orderDetailsModal').classList.contains('show')) {
            const modalBody = document.querySelector('#orderDetailsModal .modal-body');
            modalBody.innerHTML = `
                <div class="alert alert-danger">
                    <h6>Ошибка</h6>
                    <p>${message}</p>
                </div>
            `;
        } else {
            // Показываем как toast или alert
            alert(message);
        }
    }
    
    function exportOrders(format) {
        // TODO: Реализовать экспорт
        alert(`Экспорт в ${format.toUpperCase()} в разработке`);
    }
</script>
{% endblock %}
