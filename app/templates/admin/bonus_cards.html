{% extends "admin/base.html" %}

{% block page_title %}Бонусные карты{% endblock %}

{% block extra_css %}
<style>
    .card-creation-form {
        background: var(--admin-light);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .bonus-cards-table {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .card-status {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
        text-align: center;
        min-width: 100px;
    }
    
    .status-active { background-color: #28a745; color: white; }
    .status-inactive { background-color: #6c757d; color: white; }
    
    .discount-badge {
        background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-weight: 500;
    }
    
    .loading-placeholder {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }
    
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-credit-card"></i> Бонусные карты</h2>
</div>

<!-- Create Card Button -->
<div class="mb-3">
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createCardModal">
        <i class="bi bi-plus-circle"></i> Создать новую карту
    </button>
</div>

<!-- Create Card Modal -->
<div class="modal fade" id="createCardModal" tabindex="-1" aria-labelledby="createCardModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createCardModalLabel">
                    <i class="bi bi-plus-circle"></i> Создать новую карту
                </h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body">
                <form id="createCardForm">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="cardNumber" class="form-label">Номер карты *</label>
                            <input type="text" class="form-control" id="cardNumber" required 
                                   placeholder="Например: 654654">
                            <div class="form-text">Уникальный номер карты</div>
                        </div>
                        <div class="col-md-6">
                            <label for="discountPercent" class="form-label">Скидка (%) *</label>
                            <input type="number" class="form-control" id="discountPercent" required 
                                   min="1" max="100" value="10">
                            <div class="form-text">От 1 до 100%</div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="firstName" class="form-label">Имя *</label>
                            <input type="text" class="form-control" id="firstName" required 
                                   placeholder="Имя клиента">
                        </div>
                        <div class="col-md-6">
                            <label for="lastName" class="form-label">Фамилия *</label>
                            <input type="text" class="form-control" id="lastName" required 
                                   placeholder="Фамилия клиента">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="activatedAt" class="form-label">Дата активации *</label>
                            <input type="date" class="form-control" id="activatedAt" required>
                        </div>
                        <div class="col-md-6">
                            <label for="deactivatedAt" class="form-label">Дата деактивации *</label>
                            <input type="date" class="form-control" id="deactivatedAt" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="createBonusCard()">
                    <i class="bi bi-plus-circle"></i> Создать карту
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Card Modal -->
<div class="modal fade" id="editCardModal" tabindex="-1" aria-labelledby="editCardModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCardModalLabel">
                    <i class="bi bi-pencil"></i> Редактировать бонусную карту
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="updateCardForm">
                    <input type="hidden" id="editCardId">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="editCardNumber" class="form-label">Номер карты *</label>
                            <input type="text" class="form-control" id="editCardNumber" required>
                        </div>
                        <div class="col-md-6">
                            <label for="editDiscountPercent" class="form-label">Скидка (%) *</label>
                            <input type="number" class="form-control" id="editDiscountPercent" required 
                                   min="1" max="100">
                        </div>
                        <div class="col-md-6">
                            <label for="editFirstName" class="form-label">Имя *</label>
                            <input type="text" class="form-control" id="editFirstName" required>
                        </div>
                        <div class="col-md-6">
                            <label for="editLastName" class="form-label">Фамилия *</label>
                            <input type="text" class="form-control" id="editLastName" required>
                        </div>
                        <div class="col-md-6">
                            <label for="editActivatedAt" class="form-label">Дата активации *</label>
                            <input type="date" class="form-control" id="editActivatedAt" required>
                        </div>
                        <div class="col-md-6">
                            <label for="editDeactivatedAt" class="form-label">Дата деактивации *</label>
                            <input type="date" class="form-control" id="editDeactivatedAt" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    Отмена
                </button>
                <button type="button" class="btn btn-warning" onclick="updateBonusCard()">
                    Сохранить изменения
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Cards Table -->
<div class="bonus-cards-table">
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead class="table-dark">
                <tr>
                    <th>Номер карты</th>
                    <th>Скидка</th>
                    <th>Имя</th>
                    <th>Фамилия</th>
                    <th>Статус</th>
                    <th>Дата активации</th>
                    <th>Дата деактивации</th>
                    <th>Использований</th>
                    <th>Создана</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody id="cardsTableBody">
                <tr>
                    <td colspan="10" class="text-center py-4">
                        <div class="loading-placeholder">
                            <div class="spinner"></div>
                            <p>Загрузка карт...</p>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
<div class="d-flex justify-content-between align-items-center mt-3">
    <div class="pagination-controls">
        <button class="btn btn-outline-primary btn-sm" onclick="changePage(-1)" id="prevBtn" disabled>
            <i class="bi bi-chevron-left"></i> Назад
        </button>
        <span class="mx-3" id="pageInfo">Страница 1 из 1</span>
        <button class="btn btn-outline-primary btn-sm" onclick="changePage(1)" id="nextBtn" disabled>
            Вперед <i class="bi bi-chevron-right"></i>
        </button>
    </div>
    <div class="pagination-size">
        <label for="perPageSelect" class="form-label me-2">Показать:</label>
        <select class="form-select form-select-sm" id="perPageSelect" style="width: auto;">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
            <option value="100">100</option>
        </select>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentPage = 1;
    
    document.addEventListener('DOMContentLoaded', function() {
        // Инициализируем даты по умолчанию
        const today = new Date().toISOString().split('T')[0];
        const nextMonth = new Date();
        nextMonth.setMonth(nextMonth.getMonth() + 1);
        const nextMonthStr = nextMonth.toISOString().split('T')[0];
        
        document.getElementById('activatedAt').value = today;
        document.getElementById('deactivatedAt').value = nextMonthStr;
        
        // Загружаем карты
        loadBonusCards();
        
        // Обработчики событий
        document.getElementById('perPageSelect').addEventListener('change', function() {
            currentPage = 1;
            loadBonusCards();
        });
        
        // Обработчик формы редактирования карты
        document.getElementById('updateCardForm').addEventListener('submit', function(e) {
            e.preventDefault();
            updateBonusCard();
        });
        
        // Обработчик закрытия модального окна редактирования (Bootstrap 4)
        $('#editCardModal').on('hidden.bs.modal', function() {
            // Очищаем форму при закрытии модального окна
            document.getElementById('updateCardForm').reset();
        });
    });
    
    async function createBonusCard() {
        try {
            const formData = {
                card_number: document.getElementById('cardNumber').value.trim(),
                discount_percent: parseInt(document.getElementById('discountPercent').value),
                first_name: document.getElementById('firstName').value.trim(),
                last_name: document.getElementById('lastName').value.trim(),
                activated_at: document.getElementById('activatedAt').value,
                deactivated_at: document.getElementById('deactivatedAt').value
            };
            
            // Валидация
            if (!formData.card_number) {
                showAlert('Введите номер карты', 'danger');
                return;
            }
            
            if (formData.discount_percent < 1 || formData.discount_percent > 100) {
                showAlert('Скидка должна быть от 1 до 100%', 'danger');
                return;
            }
            
            if (!formData.first_name) {
                showAlert('Введите имя клиента', 'danger');
                return;
            }
            
            if (!formData.last_name) {
                showAlert('Введите фамилию клиента', 'danger');
                return;
            }
            
            if (!formData.activated_at) {
                showAlert('Выберите дату активации', 'danger');
                return;
            }
            
            if (!formData.deactivated_at) {
                showAlert('Выберите дату деактивации', 'danger');
                return;
            }
            
            if (formData.activated_at >= formData.deactivated_at) {
                showAlert('Дата деактивации должна быть позже даты активации', 'danger');
                return;
            }
            
            // Отправляем запрос
            const response = await fetch('/admin/api/bonus-cards', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify(formData)
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                showAlert('Бонусная карта успешно создана!', 'success');
                
                // Очищаем форму
                document.getElementById('createCardForm').reset();
                document.getElementById('discountPercent').value = '10';
                // Устанавливаем сегодняшнюю дату как дату активации по умолчанию
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('activatedAt').value = today;
                
                // Закрываем модальное окно
                const modal = $('#createCardModal');
                modal.modal('hide');
                
                // Перезагружаем список карт
                loadBonusCards();
                
                // Обновляем страницу через 2 секунды
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                showAlert(data.message || 'Ошибка создания карты', 'danger');
            }
        } catch (error) {
            console.error('Error creating bonus card:', error);
            showAlert('Ошибка соединения с сервером', 'danger');
        }
    }
    
    async function loadBonusCards() {
        try {
            const tableBody = document.getElementById('cardsTableBody');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="10" class="text-center py-4">
                        <div class="loading-placeholder">
                            <div class="spinner"></div>
                            <p>Загрузка карт...</p>
                        </div>
                    </td>
                </tr>
            `;
            
            // Формируем параметры запроса
            const params = new URLSearchParams({
                page: currentPage,
                per_page: document.getElementById('perPageSelect').value
            });
            
            const response = await fetch(`/admin/api/bonus-cards?${params}`);
            const data = await response.json();
            
            if (data.status === 'success') {
                displayBonusCards(data.data.cards);
                updatePagination(data.data.pagination);
            } else {
                throw new Error(data.message);
            }
        } catch (error) {
            console.error('Error loading bonus cards:', error);
            document.getElementById('cardsTableBody').innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4 text-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        <p>Ошибка загрузки карт: ${error.message}</p>
                    </td>
                </tr>
            `;
        }
    }
    
    function displayBonusCards(cards) {
        const tableBody = document.getElementById('cardsTableBody');
        
        if (cards.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4 text-muted">
                        <i class="bi bi-credit-card"></i>
                        <p>Бонусные карты не найдены</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        tableBody.innerHTML = cards.map(card => `
            <tr>
                <td><strong>${card.card_number}</strong></td>
                <td>
                    <span class="discount-badge">
                        ${card.discount_percent}%
                    </span>
                </td>
                <td>${card.first_name || 'N/A'}</td>
                <td>${card.last_name || 'N/A'}</td>
                <td>
                    <span class="card-status status-${card.is_active ? 'active' : 'inactive'}">
                        ${card.is_active ? 'Активна' : 'Неактивна'}
                    </span>
                </td>
                <td>${card.activated_at ? new Date(card.activated_at).toLocaleDateString('ru-RU') : 'N/A'}</td>
                <td>${card.deactivated_at ? new Date(card.deactivated_at).toLocaleDateString('ru-RU') : 'N/A'}</td>
                <td>
                    <span class="badge bg-info">
                        ${card.usage_count || 0}
                    </span>
                </td>
                <td>${new Date(card.created_at).toLocaleDateString('ru-RU')}</td>
                <td>
                    <button class="btn btn-sm btn-outline-warning" onclick="editCard(${card.id})" title="Редактировать">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="toggleCardStatus(${card.id})" title="${card.is_active ? 'Деактивировать' : 'Активировать'}">
                        <i class="bi bi-toggle-${card.is_active ? 'on' : 'off'}"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteCard(${card.id})" title="Удалить">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }
    
    function updatePagination(pagination) {
        document.getElementById('pageInfo').textContent = `Страница ${pagination.page} из ${pagination.pages}`;
        document.getElementById('prevBtn').disabled = !pagination.has_prev;
        document.getElementById('nextBtn').disabled = !pagination.has_next;
    }
    
    function changePage(delta) {
        currentPage += delta;
        if (currentPage < 1) currentPage = 1;
        loadBonusCards();
    }
    
    async function viewCardDetails(cardId) {
        try {
            const response = await fetch(`/admin/api/bonus-cards/${cardId}`);
            const data = await response.json();
            
            if (data.status === 'success') {
                const card = data.data;
                const details = `
                    <strong>Номер карты:</strong> ${card.card_number}<br>
                    <strong>Скидка:</strong> ${card.discount_percent}%<br>
                    <strong>Имя:</strong> ${card.first_name || 'N/A'}<br>
                    <strong>Фамилия:</strong> ${card.last_name || 'N/A'}<br>
                    <strong>Статус:</strong> ${card.is_active ? 'Активна' : 'Неактивна'}<br>
                    <strong>Дата активации:</strong> ${card.activated_at ? new Date(card.activated_at).toLocaleDateString('ru-RU') : 'N/A'}<br>
                    <strong>Дата деактивации:</strong> ${card.deactivated_at ? new Date(card.deactivated_at).toLocaleDateString('ru-RU') : 'N/A'}<br>
                    <strong>Использований:</strong> ${card.usage_count || 0}<br>
                    <strong>Создана:</strong> ${new Date(card.created_at).toLocaleDateString('ru-RU')}<br>
                    <strong>Обновлена:</strong> ${card.updated_at ? new Date(card.updated_at).toLocaleDateString('ru-RU') : 'N/A'}
                `;
                
                showAlert(`<div class="text-start">${details}</div><br><button class="btn btn-sm btn-secondary" onclick="this.parentElement.parentElement.remove()">Закрыть</button>`, 'info');
            } else {
                showAlert(data.message || 'Ошибка загрузки данных карты', 'danger');
            }
        } catch (error) {
            console.error('Error loading card details:', error);
            showAlert('Ошибка загрузки данных карты', 'danger');
        }
    }
    
    async function toggleCardStatus(cardId) {
        try {
            const response = await fetch(`/admin/api/bonus-cards/${cardId}/toggle`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                }
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                showAlert(data.message, 'success');
                loadBonusCards(); // Перезагружаем список
            } else {
                showAlert(data.message || 'Ошибка изменения статуса', 'danger');
            }
        } catch (error) {
            console.error('Error toggling card status:', error);
            showAlert('Ошибка соединения с сервером', 'danger');
        }
    }
    
    function exportCards(format) {
        // TODO: Реализовать экспорт
        showAlert(`Экспорт в ${format.toUpperCase()} в разработке`, 'info');
    }
    
    async function editCard(cardId) {
        try {
            const response = await fetch(`/admin/api/bonus-cards/${cardId}`);
            const data = await response.json();
            
            if (data.status === 'success') {
                const card = data.data;
                
                console.log('Card data received:', card); // Отладочная информация
                
                // Заполняем форму редактирования
                document.getElementById('editCardId').value = card.id;
                document.getElementById('editCardNumber').value = card.card_number || '';
                document.getElementById('editDiscountPercent').value = card.discount_percent || '';
                document.getElementById('editFirstName').value = card.first_name || '';
                document.getElementById('editLastName').value = card.last_name || '';
                document.getElementById('editActivatedAt').value = card.activated_at ? card.activated_at.split('T')[0] : '';
                document.getElementById('editDeactivatedAt').value = card.deactivated_at ? card.deactivated_at.split('T')[0] : '';
                
                // Показываем модальное окно редактирования (Bootstrap 4)
                $('#editCardModal').modal('show');
            } else {
                showAlert(data.message || 'Ошибка загрузки данных карты', 'danger');
            }
        } catch (error) {
            console.error('Error loading card for edit:', error);
            showAlert('Ошибка загрузки данных карты', 'danger');
        }
    }
    
    async function updateBonusCard() {
        try {
            const cardId = document.getElementById('editCardId').value;
            const formData = {
                card_number: document.getElementById('editCardNumber').value.trim(),
                discount_percent: parseInt(document.getElementById('editDiscountPercent').value),
                first_name: document.getElementById('editFirstName').value.trim(),
                last_name: document.getElementById('editLastName').value.trim(),
                activated_at: document.getElementById('editActivatedAt').value,
                deactivated_at: document.getElementById('editDeactivatedAt').value
            };
            
            // Валидация
            if (!formData.card_number || !formData.discount_percent || !formData.first_name || 
                !formData.last_name || !formData.activated_at || !formData.deactivated_at) {
                showAlert('Все поля обязательны для заполнения', 'danger');
                return;
            }
            
            if (formData.activated_at >= formData.deactivated_at) {
                showAlert('Дата деактивации должна быть позже даты активации', 'danger');
                return;
            }
            
            const response = await fetch(`/admin/api/bonus-cards/${cardId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify(formData)
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                showAlert('Бонусная карта успешно обновлена!', 'success');
                
                // Закрываем модальное окно (Bootstrap 4)
                $('#editCardModal').modal('hide');
                
                // Перезагружаем список карт
                loadBonusCards();
            } else {
                showAlert(data.message || 'Ошибка обновления карты', 'danger');
            }
        } catch (error) {
            console.error('Error updating bonus card:', error);
            showAlert('Ошибка соединения с сервером', 'danger');
        }
    }
    
    
    async function deleteCard(cardId) {
        // Подтверждение удаления
        if (!confirm('Вы уверены, что хотите удалить эту бонусную карту?\n\nЭто действие нельзя отменить!')) {
            return;
        }
        
        try {
            const response = await fetch(`/admin/api/bonus-cards/${cardId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                }
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                showAlert('Бонусная карта успешно удалена!', 'success');
                loadBonusCards();
            } else {
                showAlert(data.message || 'Ошибка удаления карты', 'danger');
            }
        } catch (error) {
            console.error('Error deleting bonus card:', error);
            showAlert('Ошибка соединения с сервером', 'danger');
        }
    }
    
    function showAlert(message, type) {
        // Простая функция для показа уведомлений
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.container-fluid').firstChild);
        
        // Автоматически скрываем через 5 секунд (кроме info - там не скрываем)
        if (type !== 'info') {
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
    }
</script>
{% endblock %}
