{% extends "admin/base.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–Ω–Ω–µ—Ä–∞–º–∏{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="bi bi-images"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–Ω–Ω–µ—Ä–∞–º–∏
        </h1>
        <button class="btn btn-primary" onclick="openAddBannerModal()">
            <i class="bi bi-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –±–∞–Ω–Ω–µ—Ä
        </button>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∞–Ω–Ω–µ—Ä–æ–≤ -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                –í—Å–µ–≥–æ –±–∞–Ω–Ω–µ—Ä–æ–≤
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalBanners">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-images fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                –ê–∫—Ç–∏–≤–Ω—ã–µ –±–∞–Ω–Ω–µ—Ä—ã
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="activeBanners">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                –ë–∞–Ω–Ω–µ—Ä—ã —Å –∏—Å—Ç–µ–∫–∞—é—â–µ–π –¥–∞—Ç–æ–π
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="expiringBanners">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-exclamation-triangle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                –û–±—â–∏–π —Ä–∞–∑–º–µ—Ä
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalSize">0 MB</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-hdd fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –±–∞–Ω–Ω–µ—Ä–æ–≤ -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">–°–ø–∏—Å–æ–∫ –±–∞–Ω–Ω–µ—Ä–æ–≤</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="bannersTable" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</th>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–ü–æ—Ä—è–¥–æ–∫</th>
                            <th>–î–∞—Ç—ã</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="bannersTableBody">
                        <!-- –ë–∞–Ω–Ω–µ—Ä—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–∞–Ω–Ω–µ—Ä–∞ -->
<div class="modal fade" id="bannerModal" tabindex="-1" role="dialog" aria-labelledby="bannerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bannerModalLabel">–î–æ–±–∞–≤–∏—Ç—å –±–∞–Ω–Ω–µ—Ä</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="closeBannerModal()">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="bannerForm" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="bannerTitle">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                                <input type="text" class="form-control" id="bannerTitle" name="title" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="bannerDescription">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                                <textarea class="form-control" id="bannerDescription" name="description" rows="3"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="bannerLinkUrl">–°—Å—ã–ª–∫–∞</label>
                                <input type="url" class="form-control" id="bannerLinkUrl" name="link_url" placeholder="https://...">
                            </div>
                            
                            <div class="form-group">
                                <label for="bannerLinkText">–¢–µ–∫—Å—Ç —Å—Å—ã–ª–∫–∏</label>
                                <input type="text" class="form-control" id="bannerLinkText" name="link_text" placeholder="–ù–∞–∂–º–∏—Ç–µ –∑–¥–µ—Å—å">
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="bannerImage">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ *</label>
                                <div class="custom-file">
                                    <input type="file" class="custom-file-input" id="bannerImage" name="image" accept="image/*" required>
                                    <label class="custom-file-label" for="bannerImage">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</label>
                                </div>
                                <small class="form-text text-muted">
                                    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: JPG, PNG, GIF, WebP. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 5MB.
                                </small>
                            </div>
                            
                            <div class="form-group">
                                <label>–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä</label>
                                <div class="image-preview-container">
                                    <img id="imagePreview" src="" alt="–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä" class="img-fluid rounded" style="max-height: 200px; display: none;">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="bannerStartDate">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑–∞</label>
                                <input type="datetime-local" class="form-control" id="bannerStartDate" name="start_date">
                            </div>
                            
                            <div class="form-group">
                                <label for="bannerEndDate">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–∫–∞–∑–∞</label>
                                <input type="datetime-local" class="form-control" id="bannerEndDate" name="end_date">
                            </div>
                            
                            <div class="form-group">
                                <input type="hidden" name="is_active" value="false">
                                <div class="custom-control custom-switch">
                                    <input type="checkbox" class="custom-control-input" id="bannerIsActive" onchange="updateHiddenField(this)">
                                    <label class="custom-control-label" for="bannerIsActive">–ê–∫—Ç–∏–≤–Ω—ã–π</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeBannerModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary" id="bannerSubmitBtn">
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
<div class="modal fade" id="deleteBannerModal" tabindex="-1" role="dialog" aria-labelledby="deleteBannerModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteBannerModalLabel">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="closeDeleteBannerModal()">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –±–∞–Ω–Ω–µ—Ä "<span id="deleteBannerTitle"></span>"?</p>
                <p class="text-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å. –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∞–∫–∂–µ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ —Å —Å–µ—Ä–≤–µ—Ä–∞.
                </p>
            </div>
                            <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeDeleteBannerModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBanner">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let banners = [];
let editingBannerId = null;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadBanners();
    setupEventListeners();
});

function setupEventListeners() {
    // –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    document.getElementById('bannerImage').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('imagePreview');
                preview.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã
    document.getElementById('bannerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        if (editingBannerId) {
            updateBanner(editingBannerId);
        } else {
            createBanner();
        }
    });
}

async function loadBanners() {
    try {
        console.log('üé† Loading banners...');
        showLoading();
        const response = await apiRequest('/admin/api/banners');
        
        console.log('üé† API response:', response);
        
        if (response.status === 'success') {
            banners = response.data;
            console.log('üé† Banners loaded:', banners);
            renderBannersTable();
            updateStatistics();
        } else {
            console.error('üé† API error:', response.message);
            showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–Ω–Ω–µ—Ä–æ–≤: ' + response.message, 'error');
        }
    } catch (error) {
        console.error('üé† Load error:', error);
        showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–Ω–Ω–µ—Ä–æ–≤: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

function renderBannersTable() {
    const tbody = document.getElementById('bannersTableBody');
    tbody.innerHTML = '';
    
    if (banners.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center text-muted py-4">
                    <i class="bi bi-images fa-3x mb-3"></i>
                    <p>–ë–∞–Ω–Ω–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                    <button class="btn btn-primary" onclick="openAddBannerModal()">
                        <i class="bi bi-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π –±–∞–Ω–Ω–µ—Ä
                    </button>
                </td>
            </tr>
        `;
        return;
    }
    
    banners.forEach(banner => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${banner.id}</td>
            <td>
                <div class="banner-image-container">
                    <img src="/static/assets/${banner.image_path}" alt="${banner.title}" 
                         class="img-thumbnail" style="max-width: 80px; max-height: 60px;">
                </div>
            </td>
            <td>
                <strong>${banner.title}</strong>
            </td>
            <td>
                ${banner.description || '<span class="text-muted">-</span>'}
            </td>
            <td>
                <span class="badge badge-${banner.is_active ? 'success' : 'secondary'}">
                    ${banner.is_active ? '–ê–∫—Ç–∏–≤–Ω—ã–π' : '–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–π'}
                </span>
            </td>
            <td>
                <span class="badge badge-info">${banner.sort_order}</span>
            </td>
            <td>
                ${formatBannerDates(banner)}
            </td>
            <td>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-primary" onclick="editBanner(${banner.id})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button type="button" class="btn btn-outline-${banner.is_active ? 'warning' : 'success'}" 
                            onclick="toggleBannerStatus(${banner.id})" title="${banner.is_active ? '–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'}">
                        <i class="bi bi-${banner.is_active ? 'pause' : 'play'}"></i>
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="deleteBanner(${banner.id})" title="–£–¥–∞–ª–∏—Ç—å">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function formatBannerDates(banner) {
    let dates = '';
    
    if (banner.start_date) {
        dates += `<div><small class="text-success">–ù–∞—á–∞–ª–æ: ${new Date(banner.start_date).toLocaleDateString()}</small></div>`;
    }
    
    if (banner.end_date) {
        dates += `<div><small class="text-warning">–ö–æ–Ω–µ—Ü: ${new Date(banner.end_date).toLocaleDateString()}</small></div>`;
    }
    
    if (!banner.start_date && !banner.end_date) {
        dates = '<small class="text-muted">–ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π</small>';
    }
    
    return dates;
}

function updateStatistics() {
    const total = banners.length;
    const active = banners.filter(b => b.is_active).length;
    const expiring = banners.filter(b => {
        if (!b.end_date) return false;
        const endDate = new Date(b.end_date);
        const now = new Date();
        const diffDays = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
        return diffDays <= 7 && diffDays > 0;
    }).length;
    
    document.getElementById('totalBanners').textContent = total;
    document.getElementById('activeBanners').textContent = active;
    document.getElementById('expiringBanners').textContent = expiring;
}

function openAddBannerModal() {
    editingBannerId = null;
    document.getElementById('bannerModalLabel').textContent = '–î–æ–±–∞–≤–∏—Ç—å –±–∞–Ω–Ω–µ—Ä';
    document.getElementById('bannerForm').reset();
    document.getElementById('imagePreview').style.display = 'none';
    document.getElementById('bannerSubmitBtn').innerHTML = '<span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>–°–æ–∑–¥–∞—Ç—å';
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–µ–∫–±–æ–∫—Å –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    document.getElementById('bannerIsActive').checked = true;
    updateHiddenField(document.getElementById('bannerIsActive'));
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º jQuery –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
    $('#bannerModal').modal('show');
}

async function createBanner() {
    try {
        const formData = new FormData(document.getElementById('bannerForm'));
        
        // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        console.log('üé† Form data contents:');
        for (let [key, value] of formData.entries()) {
            console.log(`üé† ${key}:`, value);
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º CSRF —Ç–æ–∫–µ–Ω
        const csrfToken = document.querySelector('meta[name=csrf-token]')?.getAttribute('content');
        console.log('üé† CSRF token:', csrfToken);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä
        const submitBtn = document.getElementById('bannerSubmitBtn');
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>–°–æ–∑–¥–∞–Ω–∏–µ...';
        submitBtn.disabled = true;
        
        const response = await apiRequest('/admin/api/banners', 'POST', formData);
        
        if (response.status === 'success') {
            closeBannerModal();
            loadBanners();
        } else {
            showAlert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±–∞–Ω–Ω–µ—Ä–∞: ' + response.message, 'error');
        }
    } catch (error) {
        showAlert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±–∞–Ω–Ω–µ—Ä–∞: ' + error.message, 'error');
    } finally {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        const submitBtn = document.getElementById('bannerSubmitBtn');
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>–°–æ–∑–¥–∞—Ç—å';
        submitBtn.disabled = false;
    }
}

async function editBanner(bannerId) {
    try {
        const response = await apiRequest(`/admin/api/banners/${bannerId}`);
        
        if (response.status === 'success') {
            const banner = response.data;
            editingBannerId = bannerId;
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('bannerModalLabel').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –±–∞–Ω–Ω–µ—Ä';
            document.getElementById('bannerSubmitBtn').innerHTML = '<span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            document.getElementById('bannerTitle').value = banner.title;
            document.getElementById('bannerDescription').value = banner.description || '';
            document.getElementById('bannerLinkUrl').value = banner.link_url || '';
            document.getElementById('bannerLinkText').value = banner.link_text || '';
            document.getElementById('bannerIsActive').checked = banner.is_active;
            updateHiddenField(document.getElementById('bannerIsActive'));
            
            if (banner.start_date) {
                document.getElementById('bannerStartDate').value = banner.start_date.slice(0, 16);
            }
            if (banner.end_date) {
                document.getElementById('bannerEndDate').value = banner.end_date.slice(0, 16);
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            if (banner.image_path) {
                document.getElementById('imagePreview').src = `/static/assets/${banner.image_path}`;
                document.getElementById('imagePreview').style.display = 'block';
            }
            
            // –î–µ–ª–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
            document.getElementById('bannerImage').required = false;
            
            $('#bannerModal').modal('show');
        } else {
            showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –±–∞–Ω–Ω–µ—Ä–∞: ' + response.message, 'error');
        }
    } catch (error) {
        showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –±–∞–Ω–Ω–µ—Ä–∞: ' + error.message, 'error');
    }
}

async function updateBanner(bannerId) {
    try {
        const formData = new FormData(document.getElementById('bannerForm'));
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä
        const submitBtn = document.getElementById('bannerSubmitBtn');
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        submitBtn.disabled = true;
        
        const response = await apiRequest(`/admin/api/banners/${bannerId}`, 'PUT', formData);
        
        if (response.status === 'success') {
            showAlert('–ë–∞–Ω–Ω–µ—Ä —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!', 'success');
            closeBannerModal();
            loadBanners();
        } else {
            showAlert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–Ω–Ω–µ—Ä–∞: ' + response.message, 'error');
        }
    } catch (error) {
        showAlert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–Ω–Ω–µ—Ä–∞: ' + error.message, 'error');
    } finally {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        const submitBtn = document.getElementById('bannerSubmitBtn');
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        submitBtn.disabled = false;
    }
}

async function deleteBanner(bannerId) {
    const banner = banners.find(b => b.id === bannerId);
    if (!banner) return;
    
    document.getElementById('deleteBannerTitle').textContent = banner.title;
    document.getElementById('confirmDeleteBanner').onclick = async () => {
        try {
            const response = await apiRequest(`/admin/api/banners/${bannerId}`, 'DELETE');
            
            if (response.status === 'success') {
                closeDeleteBannerModal();
                loadBanners();
            } else {
                showAlert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –±–∞–Ω–Ω–µ—Ä–∞: ' + response.message, 'error');
            }
        } catch (error) {
            showAlert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –±–∞–Ω–Ω–µ—Ä–∞: ' + error.message, 'error');
        }
    };
    
    $('#deleteBannerModal').modal('show');
}

async function toggleBannerStatus(bannerId) {
    try {
        const response = await apiRequest(`/admin/api/banners/${bannerId}/toggle`, 'PUT');
        
        if (response.status === 'success') {
            loadBanners();
        } else {
            showAlert('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: ' + response.message, 'error');
        }
    } catch (error) {
        showAlert('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: ' + error.message, 'error');
    }
}



// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
function closeBannerModal() {
    // –£–±–∏—Ä–∞–µ–º —Ñ–æ–∫—É—Å —Å –∫–Ω–æ–ø–æ–∫ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º
    document.getElementById('bannerSubmitBtn').blur();
    document.querySelector('#bannerModal .btn-secondary').blur();
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
    document.getElementById('bannerForm').reset();
    document.getElementById('imagePreview').style.display = 'none';
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    $('#bannerModal').modal('hide');
}

function closeDeleteBannerModal() {
    // –£–±–∏—Ä–∞–µ–º —Ñ–æ–∫—É—Å —Å –∫–Ω–æ–ø–æ–∫ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º
    document.getElementById('confirmDeleteBanner').blur();
    document.querySelector('#deleteBannerModal .btn-secondary').blur();
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    $('#deleteBannerModal').modal('hide');
}

function updateHiddenField(checkbox) {
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —á–µ–∫–±–æ–∫—Å–∞
    const hiddenField = checkbox.parentElement.parentElement.querySelector('input[type="hidden"]');
    if (hiddenField) {
        hiddenField.value = checkbox.checked ? 'true' : 'false';
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function showLoading() {
    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
}

function hideLoading() {
    // –°–∫—Ä—ã—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
}

function showAlert(message, type = 'info') {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–∏—Å—Ç–µ–º—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    if (window.NotificationManager) {
        window.NotificationManager.showSuccess(message);
    } else {
        alert(message);
    }
}
</script>

<style>
.banner-image-container {
    text-align: center;
}

.banner-image-container img {
    border-radius: 4px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}



.image-preview-container {
    min-height: 200px;
    border: 2px dashed #d1d3e2;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f8f9fc;
}

.image-preview-container img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}
</style>
{% endblock %}
