{% extends "waiter/base.html" %}

{% block title %}–ó–∞–∫–∞–∑—ã - –û—Ñ–∏—Ü–∏–∞–Ω—Ç - DENIZ Restaurant{% endblock %}

{% block content %}
<div class="orders-container">
    <div class="page-header">
        <h1>–ó–∞–∫–∞–∑—ã</h1>
        <div class="header-actions">
            <button class="btn btn-secondary" id="refreshOrders">
                <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
            </button>
        </div>
    </div>

    <div class="orders-filters">
        <div class="filter-group">
            <label>–°—Ç–∞—Ç—É—Å:</label>
            <select id="statusFilter" class="form-control">
                <option value="">–í—Å–µ</option>
                <option value="–Ω–æ–≤—ã–π">–ù–æ–≤—ã–µ</option>
                <option value="–æ–ø–ª–∞—á–µ–Ω">–û–ø–ª–∞—á–µ–Ω–Ω—ã–µ</option>
            </select>
        </div>
        <div class="filter-group">
            <label>–°—Ç–æ–ª:</label>
            <select id="tableFilter" class="form-control">
                <option value="">–í—Å–µ —Å—Ç–æ–ª—ã</option>
            </select>
        </div>
    </div>

    <div class="orders-list" id="ordersList">
        <div class="loading-placeholder">
            <div class="spinner"></div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</p>
        </div>
    </div>

    <!-- Order Detail Modal -->
    <div class="modal modal-overlay hidden" id="orderDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞</h3>
                <button type="button" class="btn-close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body" id="orderDetailContent">
                <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button type="button" class="btn btn-info" id="applyBonusCard" style="display: none;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–∞—Ä—Ç—É</button>
                <button type="button" class="btn btn-primary" id="printOrderReceipts">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø–µ—á–∞—Ç—å</button>
                <button type="button" class="btn btn-success" id="printFinalReceipt" style="display: none;">–ü–µ—á–∞—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —á–µ–∫–∞</button>
            </div>
        </div>
    </div>

    <!-- Print Status Modal -->
    <div class="modal modal-overlay hidden" id="printStatusModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–°—Ç–∞—Ç—É—Å –ø–µ—á–∞—Ç–∏</h3>
                <button type="button" class="btn-close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="printStatusContent">
                    <!-- –°—Ç–∞—Ç—É—Å –ø–µ—á–∞—Ç–∏ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// CSRF —Ç–æ–∫–µ–Ω –¥–ª—è AJAX –∑–∞–ø—Ä–æ—Å–æ–≤
const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìã Orders page initialized');
    
    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤
    async function loadOrders() {
        try {
            const statusFilter = document.getElementById('statusFilter').value;
            const tableFilter = document.getElementById('tableFilter').value;
            
            const filters = {};
            if (statusFilter) filters.status = statusFilter;
            if (tableFilter) filters.table_id = tableFilter;
            
            const ordersList = document.getElementById('ordersList');
            ordersList.innerHTML = '<div class="loading-placeholder"><div class="spinner"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</p></div>';
            
            // –ü–æ–ª—É—á–∞–µ–º –∑–∞–∫–∞–∑—ã —á–µ—Ä–µ–∑ API
            const response = await window.WaiterAPI.getOrders(filters);
            
            if (response.status === 'success' && response.data.orders.length > 0) {
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∑–∞–∫–∞–∑—ã
                let ordersHtml = '';
                response.data.orders.forEach(order => {
                    const statusColor = WaiterUtils.getOrderStatusColor(order.status);
                    const statusIcon = WaiterUtils.getOrderStatusIcon(order.status);
                    
                    ordersHtml += `
                        <div class="order-card" data-order-id="${order.id}">
                            <div class="order-header">
                                <div class="order-info">
                                    <div class="order-title">
                                        <h3>–ó–∞–∫–∞–∑ #${order.id}</h3>
                                        <span class="order-status" style="background: ${statusColor};">
                                            ${order.status}
                                        </span>
                                    </div>
                                    <div class="order-table-info">
                                        <i class="fas fa-table"></i>
                                        <span>–°—Ç–æ–ª: ${order.table_number}</span>
                                        <i class="fas fa-users"></i>
                                        <span>–ì–æ—Å—Ç–µ–π: ${order.guest_count}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="order-body">
                                <div class="order-total">
                                    <div class="total-label">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</div>
                                    <div class="total-amount">${order.total_amount} ‚ÇΩ</div>
                                </div>
                                <div class="order-meta">
                                    <div class="meta-item">
                                        <i class="fas fa-clock"></i>
                                        <span>–°–æ–∑–¥–∞–Ω: ${new Date(order.created_at).toLocaleString('ru-RU')}</span>
                                    </div>
                                    <div class="meta-item">
                                        <i class="fas fa-language"></i>
                                        <span>–Ø–∑—ã–∫: ${order.language.toUpperCase()}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="order-actions">
                                <button class="btn btn-primary" onclick="window.viewOrderDetails(${order.id})">
                                    <i class="fas fa-eye"></i> –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏
                                </button>
                                <button class="btn ${order.status === '–Ω–æ–≤—ã–π' ? 'btn-success' : 'btn-secondary'}" 
                                        onclick="${order.status === '–Ω–æ–≤—ã–π' ? `window.updateOrderStatus(${order.id})` : ''}"
                                        ${order.status === '–æ–ø–ª–∞—á–µ–Ω' ? 'disabled' : ''}>
                                    <i class="fas fa-check"></i> ${order.status === '–Ω–æ–≤—ã–π' ? '–û—Ç–º–µ—Ç–∏—Ç—å –æ–ø–ª–∞—á–µ–Ω–Ω—ã–º' : '–ó–∞–∫–∞–∑ –æ–ø–ª–∞—á–µ–Ω'}
                                </button>
                            </div>
                        </div>
                    `;
                });
                ordersList.innerHTML = ordersHtml;
            } else {
                // –ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤
                ordersList.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-clipboard-list"></i>
                        <h3>–ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                        <p>–í –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∏–ª—å—Ç—Ä–∞–º</p>
                    </div>
                `;
            }
            
        } catch (error) {
            console.error('Error loading orders:', error);
            waiterNotifications.showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤');
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞
    function updateOrderStatus(orderId) {
        // –ù–∞—Ö–æ–¥–∏–º –∑–∞–∫–∞–∑ –≤ —Å–ø–∏—Å–∫–µ
        const orderCards = document.querySelectorAll('.order-card');
        let currentOrder = null;
        
        orderCards.forEach(card => {
            if (card.dataset.orderId == orderId) {
                currentOrder = card;
            }
        });
        
        if (!currentOrder) {
            waiterNotifications.showError('–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –∏–∑ DOM
        const statusElement = currentOrder.querySelector('.order-status');
        const currentStatus = statusElement.textContent.trim();
        
        let newStatus;
        let actionText;
        
        if (currentStatus === '–Ω–æ–≤—ã–π') {
            newStatus = '–æ–ø–ª–∞—á–µ–Ω';
            actionText = '–æ—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–π';
        } else if (currentStatus === '–æ–ø–ª–∞—á–µ–Ω') {
            waiterNotifications.showInfo('–ó–∞–∫–∞–∑ —É–∂–µ –æ–ø–ª–∞—á–µ–Ω');
            return;
        } else {
            waiterNotifications.showError('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞');
            return;
        }
        
        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è
        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${actionText}?`)) {
            return;
        }
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        fetch(`/waiter/api/orders/${orderId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ status: newStatus })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                waiterNotifications.showSuccess(`–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ "${newStatus}"`);
                loadOrders(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
            } else {
                waiterNotifications.showError(data.message || '–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
            }
        })
        .catch(error => {
            console.error('Error updating order status:', error);
            waiterNotifications.showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–∞
    function viewOrderDetails(orderId) {
        console.log(`üîç –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞ #${orderId}`);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞
        fetch(`/waiter/api/orders/${orderId}`)
            .then(response => {
                console.log(`üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${response.status} ${response.statusText}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('üì¶ –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', data);
                if (data.status === 'success') {
                    displayOrderDetails(data.data.order);
                } else {
                    waiterNotifications.showError(data.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–∞');
                }
            })
            .catch(error => {
                console.error('‚ùå Error loading order details:', error);
                waiterNotifications.showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            });
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–∞
    function displayOrderDetails(order) {
        console.log('üé® –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞:', order);
        
        const modal = document.getElementById('orderDetailModal');
        const content = document.getElementById('orderDetailContent');
        const printButton = document.getElementById('printOrderReceipts');
        const finalReceiptButton = document.getElementById('printFinalReceipt');
        
        console.log('üîç –ù–∞–π–¥–µ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã:', {
            modal: modal,
            content: content,
            printButton: printButton,
            finalReceiptButton: finalReceiptButton
        });
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞–π–¥–µ–Ω—ã
        if (!modal) {
            console.error('‚ùå –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!');
            waiterNotifications.showError('–û—à–∏–±–∫–∞: –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
            return;
        }
        
        if (!content) {
            console.error('‚ùå –ö–æ–Ω—Ç–µ–Ω—Ç –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω!');
            waiterNotifications.showError('–û—à–∏–±–∫–∞: –∫–æ–Ω—Ç–µ–Ω—Ç –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        
        // –†–∞–∑–¥–µ–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ –ø–æ —Ç–∏–ø–∞–º
        const kitchenItems = order.items.filter(item => item.preparation_type === 'kitchen');
        const barItems = order.items.filter(item => item.preparation_type === 'bar');
        
        let itemsHtml = '';
        
        if (kitchenItems.length > 0) {
            itemsHtml += '<div class="items-section"><h4>üçΩÔ∏è –ö–£–•–ù–Ø</h4>';
            kitchenItems.forEach(item => {
                itemsHtml += `
                    <div class="order-item">
                        <span class="item-quantity">${item.quantity}x</span>
                        <span class="item-name">${item.name}</span>
                        <span class="item-price">${item.unit_price} ‚ÇΩ</span>
                        ${item.comments ? `<div class="item-comments">üí¨ ${item.comments}</div>` : ''}
                    </div>
                `;
            });
            itemsHtml += '</div>';
        }
        
        if (barItems.length > 0) {
            itemsHtml += '<div class="items-section"><h4>üçπ –ë–ê–†</h4>';
            barItems.forEach(item => {
                itemsHtml += `
                    <div class="order-item">
                        <span class="item-quantity">${item.quantity}x</span>
                        <span class="item-name">${item.name}</span>
                        <span class="item-price">${item.unit_price} ‚ÇΩ</span>
                        ${item.comments ? `<div class="item-comments">üí¨ ${item.comments}</div>` : ''}
                    </div>
                `;
            });
            itemsHtml += '</div>';
        }
        
        content.innerHTML = `
            <div class="order-details">
                <div class="order-summary">
                    <div class="summary-item">
                        <strong>–ó–∞–∫–∞–∑ #${order.id}</strong>
                        <span class="status-badge ${order.status}">${order.status}</span>
                    </div>
                    <div class="summary-item">
                        <strong>–°—Ç–æ–ª:</strong> ${order.table_number}
                    </div>
                    <div class="summary-item">
                        <strong>–ì–æ—Å—Ç–µ–π:</strong> ${order.guest_count}
                    </div>
                    <div class="summary-item">
                        <strong>–í—Ä–µ–º—è:</strong> ${new Date(order.created_at).toLocaleTimeString()}
                    </div>
                    ${order.bonus_card ? `
                    <div class="summary-item bonus-card-info">
                        <strong>–ë–æ–Ω—É—Å–Ω–∞—è –∫–∞—Ä—Ç–∞:</strong> 
                        <span class="bonus-card-number">${order.bonus_card.card_number}</span>
                        <span class="bonus-card-discount">(${order.bonus_card.discount_percent}% —Å–∫–∏–¥–∫–∞)</span>
                    </div>
                    ` : ''}
                </div>
                
                <div class="order-items">
                    ${itemsHtml}
                </div>
                
                <div class="order-total">
                    <div class="total-item">
                        <strong>–ü–æ–¥—ã—Ç–æ–≥:</strong> ${order.subtotal} ‚ÇΩ
                    </div>
                    ${order.discount_amount > 0 ? `
                    <div class="total-item discount-item">
                        <strong>–°–∫–∏–¥–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ:</strong> -${order.discount_amount} ‚ÇΩ
                    </div>
                    ` : ''}
                    <div class="total-item">
                        <strong>–°–µ—Ä–≤–∏—Å–Ω—ã–π —Å–±–æ—Ä:</strong> ${order.service_charge} ‚ÇΩ
                    </div>
                    <div class="total-item total-final">
                        <strong>–ò–¢–û–ì–û:</strong> ${order.total_amount} ‚ÇΩ
                    </div>
                </div>
            </div>
        `;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
        const applyBonusCardButton = document.getElementById('applyBonusCard');
        
        if (order.status === '–Ω–æ–≤—ã–π') {
            printButton.style.display = 'inline-block';
            finalReceiptButton.style.display = 'none';
            applyBonusCardButton.style.display = 'inline-block';
        } else if (order.status === '–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω') {
            printButton.style.display = 'none';
            finalReceiptButton.style.display = 'inline-block';
            applyBonusCardButton.style.display = 'none';
        } else {
            printButton.style.display = 'none';
            finalReceiptButton.style.display = 'none';
            applyBonusCardButton.style.display = 'none';
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –∑–∞–∫–∞–∑–∞ –¥–ª—è –∫–Ω–æ–ø–æ–∫
        modal.dataset.orderId = order.id;
        
        console.log('üìã –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–π HTML:', content.innerHTML);
        console.log('üéØ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        modal.classList.add('visible');
        modal.classList.remove('hidden');
        
        console.log('‚úÖ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤–∏–¥–∏–º—ã–º');
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–µ—á–∞—Ç–∏ —á–µ–∫–æ–≤ –∑–∞–∫–∞–∑–∞
    function printOrderReceipts() {
        const modal = document.getElementById('orderDetailModal');
        const orderId = modal.dataset.orderId;
        
        if (!orderId) {
            waiterNotifications.showError('ID –∑–∞–∫–∞–∑–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const printButton = document.getElementById('printOrderReceipts');
        const originalText = printButton.textContent;
        printButton.textContent = '–ü–µ—á–∞—Ç—å...';
        printButton.disabled = true;
        
        fetch(`/waiter/api/orders/${orderId}/print`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showPrintStatus(data.data);
                waiterNotifications.showSuccess('–ß–µ–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ –ø–µ—á–∞—Ç—å!');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
                const statusBadge = document.querySelector('.status-badge');
                if (statusBadge) {
                    statusBadge.textContent = '–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω';
                    statusBadge.className = 'status-badge –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω';
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —á–µ–∫–∞
                document.getElementById('printFinalReceipt').style.display = 'inline-block';
                printButton.style.display = 'none';
            } else {
                waiterNotifications.showError(data.message || '–û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏');
            }
        })
        .catch(error => {
            console.error('Error printing receipts:', error);
            waiterNotifications.showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
        })
        .finally(() => {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            printButton.textContent = originalText;
            printButton.disabled = false;
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –±–æ–Ω—É—Å–Ω–æ–π –∫–∞—Ä—Ç—ã
    function applyBonusCard() {
        const modal = document.getElementById('orderDetailModal');
        const orderId = modal.dataset.orderId;
        
        if (!orderId) {
            waiterNotifications.showError('ID –∑–∞–∫–∞–∑–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã
        const cardNumber = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –±–æ–Ω—É—Å–Ω–æ–π –∫–∞—Ä—Ç—ã (6 —Ü–∏—Ñ—Ä):');
        
        if (!cardNumber) {
            return;
        }
        
        if (cardNumber.length !== 6 || !/^\d+$/.test(cardNumber)) {
            waiterNotifications.showError('–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 6 —Ü–∏—Ñ—Ä');
            return;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const applyButton = document.getElementById('applyBonusCard');
        const originalText = applyButton.textContent;
        applyButton.textContent = '–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ...';
        applyButton.disabled = true;
        
        fetch(`/api/bonus-cards/apply/${orderId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                card_number: cardNumber
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                waiterNotifications.showSuccess(data.message);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞
                loadOrderDetails(orderId);
            } else {
                waiterNotifications.showError(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∫–∞—Ä—Ç—ã');
            }
        })
        .catch(error => {
            console.error('Error applying bonus card:', error);
            waiterNotifications.showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
        })
        .finally(() => {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            applyButton.textContent = originalText;
            applyButton.disabled = false;
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–µ—á–∞—Ç–∏ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —á–µ–∫–∞
    function printFinalReceipt() {
        const modal = document.getElementById('orderDetailModal');
        const orderId = modal.dataset.orderId;
        
        if (!orderId) {
            waiterNotifications.showError('ID –∑–∞–∫–∞–∑–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const printButton = document.getElementById('printFinalReceipt');
        const originalText = printButton.textContent;
        printButton.textContent = '–ü–µ—á–∞—Ç—å...';
        printButton.disabled = true;
        
        fetch(`/waiter/api/orders/${orderId}/print-final`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                waiterNotifications.showSuccess('–§–∏–Ω–∞–ª—å–Ω—ã–π —á–µ–∫ –Ω–∞–ø–µ—á–∞—Ç–∞–Ω!');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
                const statusBadge = document.querySelector('.status-badge');
                if (statusBadge) {
                    statusBadge.textContent = '–∑–∞–≤–µ—Ä—à–µ–Ω';
                    statusBadge.className = 'status-badge –∑–∞–≤–µ—Ä—à–µ–Ω';
                }
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–µ—á–∞—Ç–∏
                printButton.style.display = 'none';
            } else {
                waiterNotifications.showError(data.message || '–û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —á–µ–∫–∞');
            }
        })
        .catch(error => {
            console.error('Error printing final receipt:', error);
            waiterNotifications.showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
        })
        .finally(() => {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            printButton.textContent = originalText;
            printButton.disabled = false;
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–µ—á–∞—Ç–∏
    function showPrintStatus(printData) {
        const modal = document.getElementById('printStatusModal');
        const content = document.getElementById('printStatusContent');
        
        let statusHtml = '<div class="print-status">';
        
        if (printData.kitchen_printed) {
            statusHtml += '<div class="status-item success">‚úÖ –ö—É—Ö–æ–Ω–Ω—ã–π —á–µ–∫ –Ω–∞–ø–µ—á–∞—Ç–∞–Ω</div>';
        } else {
            statusHtml += '<div class="status-item error">‚ùå –û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏ –∫—É—Ö–æ–Ω–Ω–æ–≥–æ —á–µ–∫–∞</div>';
        }
        
        if (printData.bar_printed) {
            statusHtml += '<div class="status-item success">‚úÖ –ë–∞—Ä–Ω—ã–π —á–µ–∫ –Ω–∞–ø–µ—á–∞—Ç–∞–Ω</div>';
        } else {
            statusHtml += '<div class="status-item error">‚ùå –û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏ –±–∞—Ä–Ω–æ–≥–æ —á–µ–∫–∞</div>';
        }
        
        statusHtml += `<div class="status-summary">
            <p>–ö—É—Ö–æ–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π: ${printData.kitchen_items_count}</p>
            <p>–ë–∞—Ä–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π: ${printData.bar_items_count}</p>
        </div>`;
        
        statusHtml += '</div>';
        content.innerHTML = statusHtml;
        
        modal.style.display = 'block';
    }
    
    // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏
    window.updateOrderStatus = updateOrderStatus;
    window.viewOrderDetails = viewOrderDetails;
    window.printOrderReceipts = printOrderReceipts;
    window.printFinalReceipt = printFinalReceipt;

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    document.getElementById('refreshOrders').addEventListener('click', loadOrders);
    document.getElementById('statusFilter').addEventListener('change', loadOrders);
    document.getElementById('tableFilter').addEventListener('change', loadOrders);
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–µ—á–∞—Ç–∏
    document.getElementById('printOrderReceipts').addEventListener('click', printOrderReceipts);
    document.getElementById('printFinalReceipt').addEventListener('click', printFinalReceipt);
    document.getElementById('applyBonusCard').addEventListener('click', applyBonusCard);
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
    document.querySelectorAll('[data-dismiss="modal"]').forEach(button => {
        button.addEventListener('click', function() {
            console.log('üîí –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ');
            const modal = this.closest('.modal');
            if (modal) {
                modal.classList.remove('visible');
                modal.classList.add('hidden');
            }
        });
    });
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                console.log('üîí –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ');
                this.classList.remove('visible');
                this.classList.add('hidden');
            }
        });
    });
    
    // –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
    loadOrders();
});
</script>
{% endblock %}