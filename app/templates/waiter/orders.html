{% extends "waiter/base.html" %}

{% block title %}–ó–∞–∫–∞–∑—ã - –û—Ñ–∏—Ü–∏–∞–Ω—Ç - DENIZ Restaurant{% endblock %}

{% block content %}
<style>
/* –°—Ç–∏–ª–∏ –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –∑–∞–∫–∞–∑–æ–≤ */
#addItemsModal.visible {
    display: flex !important;
    opacity: 1;
    z-index: 3000;
}

#selectedItemsSection {
    position: sticky;
    bottom: 0;
    background: white;
    border-top: 2px solid #ddd;
    padding: 8px;
}

.status-group {
    margin-bottom: 2rem;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    overflow: hidden;
}

.status-group-title {
    margin: 0;
    padding: 1rem;
    font-size: 1.2rem;
    font-weight: 600;
    color: #333;
}

.pending-title {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
}

.confirmed-title {
    background: linear-gradient(135deg, #ffc107, #e0a800);
    color: black;
}

.completed-title {
    background: linear-gradient(135deg, #6c757d, #495057);
    color: white;
}

.cancelled-title {
    background: linear-gradient(135deg, #dc3545, #c82333);
    color: white;
}

.status-group .order-card {
    border: none;
    border-radius: 0;
    margin: 0;
    border-bottom: 1px solid #f0f0f0;
}

.status-group .order-card:last-child {
    border-bottom: none;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞–∫–∞–∑–æ–≤ */
.order-status {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    color: white;
    font-weight: 600;
    font-size: 0.9rem;
    text-transform: uppercase;
}

.order-close-btn {
    color: black;
    font-size: 1.5rem;
    font-weight: 600;
    cursor: pointer;
    width: 60px;
    border-radius: 15px;
}

.order-status.pending {
    background: #28a745 !important;
}

.order-status.completed {
    background: #6c757d !important;
}

.order-status.cancelled {
    background: #dc3545 !important;
}

.order-status.confirmed {
    background: #ffc107 !important;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π */
.btn-success {
    background-color: #28a745;
    border-color: #28a745;
    color: white;
}

.btn-info {
    background-color: #17a2b8;
    border-color: #17a2b8;
    color: white;
}

.btn-secondary {
    background-color: #6c757d;
    border-color: #6c757d;
    color: white;
}

.btn-danger {
    background-color: #dc3545;
    border-color: #dc3545;
    color: white;
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å–ø–∏–Ω–Ω–µ—Ä–∞ */
.fa-spin {
    animation: spin 1s linear infinite;
}

/* –º–æ–±–∏–ª—å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ */
.category-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 12px;
}
.cat-btn {
    padding: 6px 12px;
    border: 1px solid #ccc;
    border-radius: 20px;
    font-size: 14px;
    background: #f8f9fa;
    cursor: pointer;
}
.cat-btn.active {
    background: #007bff;
    color: white;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –¥—Ä–æ–ø–¥–∞—É–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π */
.category-filter {
    margin-bottom: 20px;
}

.category-filter label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
}

.category-dropdown {
    width: 100%;
    max-width: 300px;
    padding: 12px 16px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 16px;
    background: white;
    cursor: pointer;
    transition: border-color 0.3s;
}

.category-dropdown:focus {
    border-color: #007bff;
    outline: none;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
}

.category-dropdown:hover {
    border-color: #007bff;
}

/* –ú–æ–±–∏–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –¥—Ä–æ–ø–¥–∞—É–Ω–∞ */
@media (max-width: 768px) {
    .category-dropdown {
        font-size: 18px; /* –ë–æ–ª—å—à–µ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
        padding: 16px 20px;
        max-width: 100%;
    }
    
    .category-filter label {
        font-size: 16px;
        margin-bottom: 12px;
    }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –æ–ø—Ü–∏–π –¥—Ä–æ–ø–¥–∞—É–Ω–∞ */
.category-dropdown option {
    padding: 8px 12px;
    font-size: 16px;
}

/* –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π */
.category-buttons {
    display: none;
}

@media (max-width: 768px) {
    .modal-overlay{

    }
    .menu-items-grid {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    .menu-item-card {
        padding: 12px;
        font-size: 14px;
    }
    .menu-item-image {
        height: 100px;
    }
    .waiter-modal-footer{
        display: flex;
        flex-direction: column;
    }
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.item-comments-section {
width: 100%;
}

.comment-textarea {
    width: 100%;
    min-height: 60px;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    resize: vertical;
}

.comment-textarea:focus {
    border-color: #007bff;
    outline: none;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
}

.order-item {
    display: flex;
    flex-direction: column;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 8px;
    background: #f8f9fa;
}

.item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.item-quantity {
    font-weight: bold;
    color: #007bff;
}

.item-name {
    flex: 1;
    margin: 0 12px;
    font-weight: 500;
}

.item-price {
    font-weight: bold;
    color: #28a745;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≥–æ—Å—Ç–µ–π */
.guest-count-input {
    width: 80px;
    display: inline-block;
    margin-right: 8px;
}

.summary-item small {
    display: block;
    margin-top: 4px;
    color: #6c757d;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ */
.pagination-controls {
    margin-top: 20px;
    text-align: center;
}

.pagination-controls .btn {
    margin: 0 5px;
}

.current-page {
    display: inline-block;
    padding: 8px 12px;
    margin: 0 5px;
    background-color: #007bff;
    color: white;
    border-radius: 4px;
    font-weight: bold;
}

</style>

<div class="orders-container">
    <div class="page-header">
        <h1>–ó–∞–∫–∞–∑—ã</h1>
        <div class="header-actions">
            <button class="btn btn-secondary" id="refreshOrders">
                <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
            </button>
        </div>
    </div>

    <div class="orders-filters">
        <div class="filter-group">
            <label>–°—Ç–∞—Ç—É—Å:</label>
            <select id="statusFilter" class="form-control">
                <option value="">–í—Å–µ</option>
                <option value="pending">–ù–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã</option>
                <option value="confirmed">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã</option>
                <option value="completed">–û–ø–ª–∞—á–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã</option>
                <option value="cancelled">–û—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã</option>
            </select>
        </div>
    </div>

    <div class="orders-list" id="ordersList">
        <div class="loading-placeholder">
            <div class="spinner"></div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</p>
        </div>
    </div>

    <!-- Order Detail Modal -->
    <div class="modal modal-overlay hidden" id="orderDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞</h3>
                <button type="button" class="order-close-btn" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body" id="orderDetailContent">
                <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
            <div class="modal-footer waiter-modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button type="button" class="btn btn-info" id="applyBonusCard" style="display: none;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–∞—Ä—Ç—É</button>
                <button type="button" class="btn btn-primary" id="printOrderReceipts">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø–µ—á–∞—Ç—å</button>
                <button type="button" class="btn btn-success" id="printFinalReceipt" style="display: none;">–ü–µ—á–∞—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —á–µ–∫–∞</button>
            </div>
        </div>
    </div>

    <!-- Print Status Modal -->
    <div class="modal modal-overlay hidden" id="printStatusModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–°—Ç–∞—Ç—É—Å –ø–µ—á–∞—Ç–∏</h3>
                <button type="button" class="btn-close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="printStatusContent">
                    <!-- –°—Ç–∞—Ç—É—Å –ø–µ—á–∞—Ç–∏ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- =====  –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ "–î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏–∏"  ===== -->
<div class="modal modal-overlay hidden" id="addItemsModal">
    <div class="modal-content large-modal">
        <div class="modal-header">
            <h3>–î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏–∏ –∫ –∑–∞–∫–∞–∑—É #<span id="modalOrderId"></span></h3>
            <button type="button" class="order-close-btn" data-dismiss="modal">&times;</button>
        </div>

        <div class="modal-body">
            <!-- –ü–æ–∏—Å–∫ -->
            <div class="search-section">
                <div class="search-input-wrapper">
                    <input type="text" id="menuSearchInput" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é...">
                    <i class="fas fa-search search-icon"></i>
                </div>
            </div>

            <!-- –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º -->
            <div class="category-filter">
                <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
                <select id="categoryFilter" class="form-control category-dropdown">
                    <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                    <!-- –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã JS -->
                </select>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ –±–ª—é–¥ -->
            <div class="menu-items-container">
                <div id="menuItemsGrid" class="menu-items-grid">
                    <div class="loading-placeholder">
                        <div class="spinner"></div>
                        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–Ω—é...</p>
                    </div>
                </div>
            </div>

            <!-- –í—ã–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ -->
            <div id="selectedItemsSection" class="selected-items-section" style="display:none;">
                <h4>–í—ã–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏</h4>
                <div id="selectedItemsList" class="selected-items-list"></div>
                <div id="selectedItemsTotal" class="selected-items-total">
                    –ò—Ç–æ–≥–æ: <span>0</span> TMT
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
            <button type="button" class="btn btn-success" id="confirmAddItems" disabled>
                <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// CSRF —Ç–æ–∫–µ–Ω –¥–ª—è AJAX –∑–∞–ø—Ä–æ—Å–æ–≤
const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

// –û–±—ä—è–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ
let updateOrderStatus, viewOrderDetails, printOrderReceipts, printFinalReceipt, applyBonusCard;

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤
let statusReference = {};

// –°–æ—Å—Ç–æ—è–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
const modalState = {
    orderDetailOpen: false,
    addItemsOpen: false
};

document.addEventListener('DOMContentLoaded', function() {
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Å—Ç–∞—Ç—É—Å–æ–≤
    loadStatusReference();
    
    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤
    async function loadStatusReference() {
        try {
            const response = await fetch('/waiter/api/order-statuses');
            const data = await response.json();
            
            if (data.status === 'success') {
                statusReference = {};
                data.data.forEach(status => {
                    statusReference[status.code] = status;
                });
            } else {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤:', data.message);
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤:', error);
        }
    }

    // ========= –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ó–ê–ö–†–´–¢–ò–Ø –ú–û–î–ê–õ–û–ö =========
    function closeAllModals() {
        console.log('üîß –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞');
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–∞
        const orderModal = document.getElementById('orderDetailModal');
        if (orderModal) {
            orderModal.style.display = 'none';
            orderModal.classList.remove('show', 'visible');
            orderModal.classList.add('hidden');
            orderModal.setAttribute('aria-hidden', 'true');
            orderModal.removeAttribute('aria-modal');
            modalState.orderDetailOpen = false;
        }
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π
        const addItemsModal = document.getElementById('addItemsModal');
        if (addItemsModal) {
            addItemsModal.classList.remove('visible');
            addItemsModal.classList.add('hidden');
            modalState.addItemsOpen = false;
        }
        
        // –£–±–∏—Ä–∞–µ–º –≤—Å–µ backdrop'—ã
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
        
        // –ò–°–ü–†–ê–í–õ–Ø–ï–ú: –ü—Ä–∞–≤–∏–ª—å–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ body
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
        document.body.style.marginRight = '';
        document.body.style.position = '';
        
        console.log('‚úÖ –í—Å–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –∑–∞–∫—Ä—ã—Ç—ã, body –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
    }

    // ========= –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò –û–ë–†–ê–ë–û–¢–ß–ò–ö–û–í =========
    function registerEventHandlers() {
        console.log('üîß –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π');
        
        // –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º –≤—Å–µ —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å –Ω–∞—à–∏—Ö –∫–Ω–æ–ø–æ–∫
        document.querySelectorAll('[data-action]').forEach(button => {
            // –ö–ª–æ–Ω–∏—Ä—É–µ–º —ç–ª–µ–º–µ–Ω—Ç —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            const newButton = button.cloneNode(true);
            button.parentNode.replaceChild(newButton, button);
        });
        
        // –¢–µ–ø–µ—Ä—å –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        document.querySelectorAll('[data-action]').forEach(button => {
            const action = button.getAttribute('data-action');
            const orderId = button.getAttribute('data-order-id');
            
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                console.log('üîß –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ:', action, '–¥–ª—è –∑–∞–∫–∞–∑–∞ #' + orderId);
                
                switch(action) {
                    case 'view-details':
                        viewOrderDetails(orderId);
                        break;
                    case 'print-receipts':
                        printOrderReceiptsFromCard(orderId);
                        break;
                    case 'mark-paid':
                        updateOrderStatus(orderId);
                        break;
                    case 'add-items':
                        addMoreItems(orderId);
                        break;
                    case 'cancel-order':
                        cancelOrder(orderId);
                        break;
                }
            });
        });
        
        console.log('‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã');
    }

    // ========= –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê ¬´–î–û–ë–ê–í–ò–¢–¨ –ü–û–ó–ò–¶–ò–ò¬ª =========
    window.addMoreItems = function(orderId) {
        console.log('üîß –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –∑–∞–∫–∞–∑–∞ #' + orderId);
        
        // –°–Ω–∞—á–∞–ª–∞ –∑–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –º–æ–¥–∞–ª–∫–∏
        closeAllModals();
        
        const modal = document.getElementById('addItemsModal');
        modal.dataset.orderId = orderId;
        document.getElementById('modalOrderId').textContent = orderId;
        modal.classList.remove('hidden');
        modal.classList.add('visible');
        modalState.addItemsOpen = true;
        
        loadMenuForOrder(orderId);
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π
    document.querySelectorAll('#addItemsModal [data-dismiss="modal"]').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            closeAllModals();
        });
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–Ω—é –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    async function loadMenuForOrder(orderId) {
        try {
            const res = await fetch('/api/menu');
            const data = await res.json();

            // –£–¥–∞–ª—è–µ–º —Å–ø–∏–Ω–Ω–µ—Ä
            document.querySelector('#menuItemsGrid .loading-placeholder')?.remove();

            // –ï—Å–ª–∏ –≤—Å—ë –æ–∫ ‚Äì —Ä–µ–Ω–¥–µ—Ä–∏–º
            if (data.status === 'success') {
                renderMenuItems(data.data.categories);
                document.getElementById('modalOrderId').textContent = orderId;
            } else {
                throw new Error(data.message || '–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö');
            }
        } catch (e) {
            console.error('‚ùå loadMenuForOrder error:', e);
            waiterNotifications.showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–µ–Ω—é: ' + e.message);
        }
    }

    function renderMenuItems(categories) {
        const grid = document.getElementById('menuItemsGrid');
        const dropdown = document.getElementById('categoryFilter');
        
        // —á–∏—Å—Ç–∏–º
        grid.innerHTML = '';
        dropdown.innerHTML = '<option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>';

        categories.forEach(cat => {
            // –æ–ø—Ü–∏—è –¥–ª—è –¥—Ä–æ–ø–¥–∞—É–Ω–∞
            const option = document.createElement('option');
            option.value = cat.id;
            option.textContent = cat.name;
            dropdown.appendChild(option);

            // –∫–∞—Ä—Ç–æ—á–∫–∏
            (cat.items || []).forEach(item => {
                const card = document.createElement('div');
                card.className = 'menu-item-card';
                card.dataset.itemId = item.id;
                card.dataset.price = item.price;
                card.dataset.categoryId = cat.id;

                card.innerHTML = `
                    <div class="item-row">
                        <div class="item-info">
                            <div class="item-name">${item.name}</div>
                            <div class="item-price">${item.price} TMT</div>
                        </div>
                        <div class="item-controls">
                            <button onclick="toggleSelectItem(this.closest('.menu-item-card'))">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="item-details hidden">
                        <input type="number" min="1" value="1" class="qty-input">
                        <textarea placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" class="comment-input"></textarea>
                    </div>
                `;
                grid.appendChild(card);
            });
        });

        // —É–±–∏—Ä–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä
        document.querySelector('#menuItemsGrid .loading-placeholder')?.remove();
    }


    // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    function filterMenu() {
        const searchTerm = document.getElementById('menuSearchInput').value.toLowerCase();
        const categoryId = document.getElementById('categoryFilter').value;
        
        document.querySelectorAll('.menu-item-card').forEach(card => {
            const name = card.querySelector('.item-name').textContent.toLowerCase();
            const cardCategoryId = card.dataset.categoryId;
            
            const matchesSearch = !searchTerm || name.includes(searchTerm);
            const matchesCategory = !categoryId || cardCategoryId === categoryId;
            
            card.style.display = (matchesSearch && matchesCategory) ? 'block' : 'none';
        });
    }

    // –í—ã–±–æ—Ä / –æ—Ç–º–µ–Ω–∞ –±–ª—é–¥–∞
    window.toggleSelectItem = function(card) {
        card.classList.toggle('selected');
        const details = card.querySelector('.item-details');
        details.classList.toggle('hidden');
        updateSelectedSection();
    };

    window.changeQty = function(btn, delta) {
        const input = btn.parentElement.querySelector('input');
        let val = parseInt(input.value) + delta;
        if (val < 1) val = 1;
        input.value = val;
        updateSelectedSection();
    };

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    document.getElementById('menuSearchInput').addEventListener('input', filterMenu);
    document.getElementById('categoryFilter').addEventListener('change', filterMenu);


    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö
    function updateSelectedSection() {
        const selected = document.querySelectorAll('.menu-item-card.selected');
        const list = document.getElementById('selectedItemsList');
        const totalEl = document.getElementById('selectedItemsTotal').querySelector('span');
        list.innerHTML = '';
        let total = 0;

        selected.forEach(card => {
            const id   = card.dataset.itemId;
            const name = card.querySelector('.item-name').textContent;
            const price = parseFloat(card.dataset.price);
            const qty  = parseInt(card.querySelector('.qty-input').value);
            total += price * qty;

            const itemDiv = document.createElement('div');
            itemDiv.className = 'selected-item';
            itemDiv.innerHTML = `
                <div>${name} √ó ${qty}</div>
                <div>${(price * qty).toFixed(2)} TMT</div>
            `;
            list.appendChild(itemDiv);
        });

        totalEl.textContent = total.toFixed(2);
        document.getElementById('selectedItemsSection').style.display = selected.length ? 'block' : 'none';
        document.getElementById('confirmAddItems').disabled = !selected.length;
    }

    // ========= –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –û–¢–ü–†–ê–í–ö–ê –î–û–ë–ê–í–õ–ï–ù–ù–´–• –ü–û–ó–ò–¶–ò–ô =========
    document.getElementById('confirmAddItems').addEventListener('click', async () => {
        const orderId = document.getElementById('modalOrderId').textContent;
        const items = [...document.querySelectorAll('.menu-item-card.selected')].map(card => ({
            menu_item_id: parseInt(card.dataset.itemId),
            quantity: parseInt(card.querySelector('.qty-input').value),
            comments: card.querySelector('.comment-input').value.trim()
        }));

        try {
            const res = await fetch(`/waiter/api/orders/${orderId}/add-items`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ items })
            });
            const data = await res.json();
            if (data.status === 'success') {
                waiterNotifications.showSuccess(data.message);
                
                // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                closeAllModals();
                
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
                setTimeout(() => {
                    loadOrders();
                }, 100);
                
            } else {
                waiterNotifications.showError(data.message);
            }
        } catch (e) {
            waiterNotifications.showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
        }
    });


    function closeOrderModal() {
        console.log('üîç closeOrderModal –≤—ã–∑–≤–∞–Ω–∞');
        const modal = document.getElementById('orderDetailModal');
        if (modal) {
            const orderId = modal.dataset.orderId;
            console.log(' –ú–æ–¥–∞–ª–∫–∞ –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–∞ #' + (orderId || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ') + ' –ó–ê–ö–†–´–¢–ê');
            
            // –õ–æ–≥–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–æ–¥–∞–ª–∫–∏ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º
            console.log('üîç –°–æ—Å—Ç–æ—è–Ω–∏–µ –º–æ–¥–∞–ª–∫–∏ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º:', {
                display: modal.style.display,
                classes: modal.className,
                ariaHidden: modal.getAttribute('aria-hidden'),
                ariaModal: modal.getAttribute('aria-modal')
            });
            
            // –ï–î–ò–ù–´–ô –°–ü–û–°–û–ë: —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∫–ª–∞—Å—Å—ã
            modal.classList.remove('visible', 'show');
            modal.classList.add('hidden');
            
            // –£–±–∏—Ä–∞–µ–º backdrop
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) {
                console.log('üîç –£–±–∏—Ä–∞–µ–º backdrop');
                backdrop.remove();
            }
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–∫—Ä–æ–ª–ª –∫ body
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            document.body.style.marginRight = '';
            
            console.log('üîç –ú–æ–¥–∞–ª–∫–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–∫—Ä—ã—Ç–∞, –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∞–∫—Ç–∏–≤–Ω—ã');
            
            // –ü–†–û–í–ï–†–Ø–ï–ú: —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è
            setTimeout(() => {
                console.log('ÔøΩÔøΩ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∫–∏...');
                const testButton = document.querySelector('[data-action="view-details"]');
                if (testButton) {
                    console.log('üîç –¢–µ—Å—Ç–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è:', testButton);
                    console.log('üîç –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ –∫–Ω–æ–ø–∫–µ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è:', testButton.onclick, testButton._clickHandler);
                }
            }, 500);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π
    function closeAddItemsModal() {
        const modal = document.getElementById('addItemsModal');
        if (modal) {
            const orderId = modal.dataset.orderId;
            console.log('üîß –ú–æ–¥–∞–ª–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏–∏" –¥–ª—è –∑–∞–∫–∞–∑–∞ #' + (orderId || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ') + ' –ó–ê–ö–†–´–¢–ê');
            
            modal.classList.remove('visible');
            modal.classList.add('hidden');
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤
    async function loadOrders(page = 1) {
        console.log('ÔøΩÔøΩ loadOrders –≤—ã–∑–≤–∞–Ω–∞, —Å—Ç—Ä–∞–Ω–∏—Ü–∞:', page);
        try {
            const statusFilter = document.getElementById('statusFilter').value;
            
            const filters = {};
            if (statusFilter) filters.status = statusFilter;
            if (page) filters.page = page; // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            
            const ordersList = document.getElementById('ordersList');
            ordersList.innerHTML = '<div class="loading-placeholder"><div class="spinner"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</p></div>';
            
            // –ü–æ–ª—É—á–∞–µ–º –∑–∞–∫–∞–∑—ã —á–µ—Ä–µ–∑ API
            const response = await window.WaiterAPI.getOrders(filters);
            
            if (response.status === 'success' && response.data.orders.length > 0) {
                console.log('üîç –ü–æ–ª—É—á–µ–Ω–æ –∑–∞–∫–∞–∑–æ–≤:', response.data.orders.length);
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∑–∞–∫–∞–∑—ã: —Å–Ω–∞—á–∞–ª–∞ pending, –ø–æ—Ç–æ–º confirmed, –ø–æ—Ç–æ–º completed, –ø–æ—Ç–æ–º cancelled
                const sortedOrders = response.data.orders.sort((a, b) => {
                    const statusOrder = { 'pending': 1, 'confirmed': 2, 'completed': 3, 'cancelled': 4 };
                    const aOrder = statusOrder[a.status] || 5;
                    const bOrder = statusOrder[b.status] || 5;
                    
                    if (aOrder !== bOrder) {
                        return aOrder - bOrder;
                    }
                    
                    // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å—ã –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ, —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–¥–∞–Ω–∏—è (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏)
                    return new Date(b.created_at) - new Date(a.created_at);
                });
                
                // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∑–∞–∫–∞–∑—ã –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
                const ordersByStatus = {
                    pending: [],
                    confirmed: [],
                    completed: [],
                    cancelled: []
                };
                
                sortedOrders.forEach(order => {
                    if (ordersByStatus[order.status]) {
                        ordersByStatus[order.status].push(order);
                    }
                });

                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∑–∞–∫–∞–∑—ã —Å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π
                let ordersHtml = '';
                
                // Pending –∑–∞–∫–∞–∑—ã (–Ω–æ–≤—ã–µ) - –∑–µ–ª–µ–Ω—ã–π —Ü–≤–µ—Ç
                if (ordersByStatus.pending.length > 0) {
                    const statusInfo = statusReference['pending'] || { name: '–ù–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã', icon: 'üü¢' };
                    ordersHtml += '<div class="status-group pending-group">';
                    ordersHtml += `<h3 class="status-group-title pending-title">${statusInfo.icon} ${statusInfo.name}</h3>`;
                    ordersByStatus.pending.forEach(order => {
                        ordersHtml += createOrderCard(order);
                    });
                    ordersHtml += '</div>';
                }
                
                // Confirmed –∑–∞–∫–∞–∑—ã (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ) - –∂–µ–ª—Ç—ã–π —Ü–≤–µ—Ç
                if (ordersByStatus.confirmed.length > 0) {
                    const statusInfo = statusReference['confirmed'] || { name: '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã', icon: '‚úÖ' };
                    ordersHtml += '<div class="status-group confirmed-group">';
                    ordersHtml += `<h3 class="status-group-title confirmed-title">${statusInfo.icon} ${statusInfo.name}</h3>`;
                    ordersByStatus.confirmed.forEach(order => {
                        ordersHtml += createOrderCard(order);
                    });
                    ordersHtml += '</div>';
                }
                
                // Completed –∑–∞–∫–∞–∑—ã (–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ) - —Å–µ—Ä—ã–π —Ü–≤–µ—Ç
                if (ordersByStatus.completed.length > 0) {
                    const statusInfo = statusReference['completed'] || { name: '–û–ø–ª–∞—á–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã', icon: '‚ö´' };
                    ordersHtml += '<div class="status-group completed-group">';
                    ordersHtml += `<h3 class="status-group-title completed-title">${statusInfo.icon} ${statusInfo.name}</h3>`;
                    ordersByStatus.completed.forEach(order => {
                        ordersHtml += createOrderCard(order);
                    });
                    ordersHtml += '</div>';
                }
                
                // Cancelled –∑–∞–∫–∞–∑—ã (–æ—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ) - –∫—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç
                if (ordersByStatus.cancelled.length > 0) {
                    const statusInfo = statusReference['cancelled'] || { name: '–û—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã', icon: '‚ùå' };
                    ordersHtml += '<div class="status-group cancelled-group">';
                    ordersHtml += `<h3 class="status-group-title cancelled-title">${statusInfo.icon} ${statusInfo.name}</h3>`;
                    ordersByStatus.cancelled.forEach(order => {
                        ordersHtml += createOrderCard(order);
                    });
                    ordersHtml += '</div>';
                }
                
                ordersList.innerHTML = ordersHtml + createPaginationControls(response.data.pagination);
                console.log('üîç –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω');
                
                // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
                setTimeout(() => {
                    registerEventHandlers();
                }, 50);
                
            } else {
                // –ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤
                ordersList.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-clipboard-list"></i>
                        <h3>–ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                        <p>–í –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∏–ª—å—Ç—Ä–∞–º</p>
                    </div>
                `;
                console.log('üîç –ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
            }
            
        } catch (error) {
            console.error('Error loading orders:', error);
            waiterNotifications.showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤');
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ –∑–∞–∫–∞–∑–∞
    function createOrderCard(order) {
        const statusColor = getStatusColor(order.status);
        const statusIcon = getStatusIcon(order.status);
        const calculatedTotal = (parseFloat(order.subtotal) + parseFloat(order.service_charge) - parseFloat(order.discount_amount || 0)).toFixed(2);
        
        return `
            <div class="order-card" data-order-id="${order.id}">
                <div class="order-header">
                    <div class="order-info">
                        <div class="order-title">
                            <h3>–ó–∞–∫–∞–∑ #${order.id}</h3>
                            <span class="order-status ${order.status}" style="background: ${statusColor};">
                                ${statusIcon} ${order.status.toUpperCase()}
                            </span>
                        </div>
                        <div class="order-table-info">
                            <i class="fas fa-table"></i>
                            <span>–°—Ç–æ–ª: ${order.table_number}</span>
                            <i class="fas fa-users"></i>
                            <span>–ì–æ—Å—Ç–µ–π: ${order.guest_count}</span>
                        </div>
                    </div>
                </div>
                <div class="order-body">
                    <div class="order-total">
                        <div class="total-label">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</div>
                        <div class="total-amount">${calculatedTotal} TMT</div>
                    </div>
                    <div class="order-meta">
                        <div class="meta-item">
                            <i class="fas fa-clock"></i>
                            <span>–°–æ–∑–¥–∞–Ω: ${new Date(order.created_at).toLocaleString('ru-RU')}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-language"></i>
                            <span>–Ø–∑—ã–∫: ${order.language.toUpperCase()}</span>
                        </div>
                    </div>
                </div>
                <div class="order-actions">
                    <button class="btn btn-primary" data-action="view-details" data-order-id="${order.id}">
                        <i class="fas fa-eye"></i> –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏
                    </button>
                    ${order.status === 'pending' ? `
                        <button class="btn btn-info" data-action="print-receipts" data-order-id="${order.id}">
                            <i class="fas fa-print"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø–µ—á–∞—Ç—å
                        </button>
                        <button class="btn btn-danger" data-action="cancel-order" data-order-id="${order.id}">
                            <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑
                        </button>
                    ` : order.status === 'confirmed' ? `
                        <button class="btn btn-success" ${order.final_receipt_printed ? '' : 'disabled'} data-action="mark-paid" data-order-id="${order.id}">
                            <i class="fas fa-check"></i> –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–π
                        </button>
                        <button class="btn btn-warning" data-action="add-items" data-order-id="${order.id}">
                            <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å
                        </button>
                        <button class="btn btn-danger" data-action="cancel-order" data-order-id="${order.id}">
                            <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑
                        </button>
                    ` : order.status === 'completed' ? `
                        <button class="btn btn-secondary" disabled>
                            <i class="fas fa-check"></i> –ó–∞–∫–∞–∑ –æ–ø–ª–∞—á–µ–Ω
                        </button>
                    ` : order.status === 'cancelled' ? `
                        <button class="btn btn-secondary" disabled>
                            <i class="fas fa-times"></i> –ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω
                        </button>
                    ` : ''}
                </div>
            </div>
        `;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ —Å—Ç–∞—Ç—É—Å–∞ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞
    function getStatusColor(status) {
        if (statusReference[status] && statusReference[status].color) {
            return statusReference[status].color;
        }
        const fallbackColors = {
            'pending': '#28a745',
            'confirmed': '#ffc107',
            'completed': '#6c757d',
            'cancelled': '#dc3545'
        };
        return fallbackColors[status] || '#6c757d';
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∫–æ–Ω–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞
    function getStatusIcon(status) {
        if (statusReference[status] && statusReference[status].icon) {
            return statusReference[status].icon;
        }
        const fallbackIcons = {
            'pending': 'üü¢',
            'confirmed': '‚úÖ',
            'completed': '‚ö´',
            'cancelled': '‚ùå'
        };
        return fallbackIcons[status] || '‚ö´';
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≥–æ—Å—Ç–µ–π
    async function updateGuestCount(orderId) {
        const guestCountInput = document.getElementById('guestCountInput');
        const guestCount = parseInt(guestCountInput.value);
        
        if (!guestCount || guestCount < 1) {
            waiterNotifications.showError('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π');
            return;
        }
        
        try {
            const response = await fetch(`/waiter/api/orders/${orderId}/guest-count`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({ guest_count: guestCount })
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                waiterNotifications.showSuccess('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                loadOrders();
            } else {
                waiterNotifications.showError(result.message);
                guestCountInput.value = result.data?.previous_guest_count || guestCountInput.defaultValue;
            }
        } catch (error) {
            console.error('Error updating guest count:', error);
            waiterNotifications.showError('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∫ –ø–æ–∑–∏—Ü–∏–∏
    async function updateItemComment(orderId, itemId, comments) {
        try {
            const response = await fetch(`/waiter/api/orders/${orderId}/items/${itemId}/comments`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({ comments: comments })
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                waiterNotifications.showSuccess('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–±–Ω–æ–≤–ª–µ–Ω');
            } else {
                waiterNotifications.showError(result.message);
            }
        } catch (error) {
            console.error('Error updating comments:', error);
            waiterNotifications.showError('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
    function getCsrfToken() {
        return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    }
    
    // –§—É–Ω–∫—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞
    function updateOrderStatus(orderId) {
        
        // –ù–∞—Ö–æ–¥–∏–º –∑–∞–∫–∞–∑ –≤ —Å–ø–∏—Å–∫–µ
        const orderCards = document.querySelectorAll('.order-card');
        
        let currentOrder = null;
        
        orderCards.forEach(card => {
            if (card.dataset.orderId == orderId) {
                currentOrder = card;
            }
        });
        
        if (!currentOrder) {
            console.error(`‚ùå –ö–∞—Ä—Ç–æ—á–∫–∞ –∑–∞–∫–∞–∑–∞ ${orderId} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞`);
            waiterNotifications.showError('–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –∏–∑ DOM
        const statusElement = currentOrder.querySelector('.order-status');
        
        if (!statusElement) {
            console.error(`‚ùå –≠–ª–µ–º–µ–Ω—Ç —Å—Ç–∞—Ç—É—Å–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –∑–∞–∫–∞–∑–∞ ${orderId}`);
            waiterNotifications.showError('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞');
            return;
        }
        
        const currentStatus = statusElement.textContent.trim();
        
        let newStatus;
        let actionText;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å, –∏–≥–Ω–æ—Ä–∏—Ä—É—è —ç–º–æ–¥–∑–∏ –∏ –ø—Ä–æ–±–µ–ª—ã
        const cleanStatus = currentStatus.replace(/[üü¢‚ö´üî¥‚úÖ‚ùå]/g, '').trim().toLowerCase();
        
        // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º —Å—Ç–∞—Ç—É—Å–µ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞
        const currentStatusInfo = statusReference[cleanStatus];
        if (!currentStatusInfo) {
            console.error(`‚ùå –°—Ç–∞—Ç—É—Å "${cleanStatus}" –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ`);
            waiterNotifications.showError('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞');
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Å—Ç–∞—Ç—É—Å—É completed
        if (canTransitionTo(cleanStatus, 'completed')) {
            newStatus = 'completed';
            actionText = '–æ—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–π';
        } else if (cleanStatus === 'completed') {
            waiterNotifications.showInfo('–ó–∞–∫–∞–∑ —É–∂–µ –æ–ø–ª–∞—á–µ–Ω');
            return;
        } else if (cleanStatus === 'cancelled') {
            waiterNotifications.showInfo('–ó–∞–∫–∞–∑ —É–∂–µ –æ—Ç–º–µ–Ω–µ–Ω');
            return;
        } else {
            console.error(`‚ùå –ü–µ—Ä–µ—Ö–æ–¥ –∫ completed –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ "${cleanStatus}"`);
            const currentStatusName = getStatusName(cleanStatus);
            const targetStatusName = getStatusName('completed');
            waiterNotifications.showError(`–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ —Å "${currentStatusName}" –Ω–∞ "${targetStatusName}"`);
            return;
        }
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        
        fetch(`/waiter/api/orders/${orderId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ status: newStatus })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                waiterNotifications.showSuccess(`–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ "${newStatus}"`);
                loadOrders(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
            } else {
                waiterNotifications.showError(data.message || '–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
            }
        })
        .catch(error => {
            console.error('Error updating order status:', error);
            waiterNotifications.showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞ —Å—Ç–∞—Ç—É—Å–∞
    function canTransitionTo(currentStatus, targetStatus) {
        if (!statusReference[currentStatus]) {
            console.warn(`‚ö†Ô∏è –°—Ç–∞—Ç—É—Å "${currentStatus}" –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ`);
            return false;
        }
        
        const allowedTransitions = statusReference[currentStatus].can_transition_to || [];
        const canTransition = allowedTransitions.includes(targetStatus);
        
        return canTransition;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
    function getStatusName(statusCode) {
        if (statusReference[statusCode] && statusReference[statusCode].name) {
            return statusReference[statusCode].name;
        }
        // Fallback –Ω–∞–∑–≤–∞–Ω–∏—è
        const fallbackNames = {
            'pending': '–ù–æ–≤—ã–π –∑–∞–∫–∞–∑',
            'confirmed': '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω',
            'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω',
            'cancelled': '–û—Ç–º–µ–Ω–µ–Ω'
        };
        return fallbackNames[statusCode] || statusCode;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–º–µ–Ω—ã –∑–∞–∫–∞–∑–∞
    function cancelOrder(orderId) {
        
        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç–º–µ–Ω—ã
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑? –ó–∞–∫–∞–∑ –±—É–¥–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω.')) {
            return;
        }
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ—Ç–º–µ–Ω—É
        fetch(`/waiter/api/orders/${orderId}/cancel`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                waiterNotifications.showSuccess('–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ç–º–µ–Ω–µ–Ω');
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤
                loadOrders();
            } else {
                waiterNotifications.showError(data.message || '–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –∑–∞–∫–∞–∑–∞');
            }
        })
        .catch(error => {
            console.error('Error cancelling order:', error);
            waiterNotifications.showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
        });
    }

    // ========= –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ü–†–û–°–ú–û–¢–†–ê –î–ï–¢–ê–õ–ï–ô –ó–ê–ö–ê–ó–ê =========
    function viewOrderDetails(orderId) {
        console.log('üîß –û—Ç–∫—Ä—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞ #' + orderId);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞
        if (document.body.style.pointerEvents === 'none') {
            console.log('üîß –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞, —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º');
            document.body.style.pointerEvents = '';
        }
        
        // –°–Ω–∞—á–∞–ª–∞ –∑–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –º–æ–¥–∞–ª–∫–∏
        closeAllModals();
        
        fetch(`/waiter/api/orders/${orderId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    displayOrderDetails(data.data.order);
                } else {
                    waiterNotifications.showError(data.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–∞');
                }
            })
            .catch(error => {
                console.error('‚ùå Error loading order details:', error);
                waiterNotifications.showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            });
    }

    // ========= –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –î–ï–¢–ê–õ–ï–ô –ó–ê–ö–ê–ó–ê =========
    function displayOrderDetails(order) {
        console.log('üîß –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞ #' + order.id);
        
        const modal = document.getElementById('orderDetailModal');
        const content = document.getElementById('orderDetailContent');
        const printButton = document.getElementById('printOrderReceipts');
        const finalReceiptButton = document.getElementById('printFinalReceipt');
        
        if (!modal || !content) {
            console.error('‚ùå –≠–ª–µ–º–µ–Ω—Ç—ã –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!');
            waiterNotifications.showError('–û—à–∏–±–∫–∞: –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
            return;
        }

        const originalItems = order.items.filter(item => 
            new Date(item.created_at) <= new Date(order.created_at)
        );
        const addedItems = order.items.filter(item => 
            new Date(item.created_at) > new Date(order.created_at)
        );
        
        let itemsHtml = '';
        
        // –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –≤ –∑–∞–∫–∞–∑–µ)
        if (originalItems.length > 0) {
            const originalKitchenItems = originalItems.filter(item => item.preparation_type === 'kitchen');
            const originalBarItems = originalItems.filter(item => item.preparation_type === 'bar');
            
            if (originalKitchenItems.length > 0) {
                itemsHtml += '<div class="items-section"><h4>üçΩÔ∏è –ö–£–•–ù–Ø</h4>';
                originalKitchenItems.forEach(item => {
                    itemsHtml += createItemHtml(item, order.id);
                });
                itemsHtml += '</div>';
            }
            
            if (originalBarItems.length > 0) {
                itemsHtml += '<div class="items-section"><h4>üç∫ –ë–ê–†</h4>';
                originalBarItems.forEach(item => {
                    itemsHtml += createItemHtml(item, order.id);
                });
                itemsHtml += '</div>';
            }
        }

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ (–¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –ø–æ–∑–∂–µ)
        if (addedItems.length > 0) {
            itemsHtml += '<div class="items-section added-items"><h4>‚ûï –î–û–ü. –ó–ê–ö–ê–ó–´</h4>';
            
            const addedKitchenItems = addedItems.filter(item => item.preparation_type === 'kitchen');
            const addedBarItems = addedItems.filter(item => item.preparation_type === 'bar');
            
            if (addedKitchenItems.length > 0) {
                itemsHtml += '<div class="added-kitchen items-section"><h4>üçΩÔ∏è –ö–£–•–ù–Ø</h4>';
                addedKitchenItems.forEach(item => {
                    itemsHtml += createItemHtml(item, order.id);
                });
                itemsHtml += '</div>';
            }
            
            if (addedBarItems.length > 0) {
                itemsHtml += '<div class="added-bar items-section"><h4>üç∫ –ë–ê–†</h4>';
                addedBarItems.forEach(item => {
                    itemsHtml += createItemHtml(item, order.id);
                });
                itemsHtml += '</div>';
            }
            
            itemsHtml += '</div>';
        }
        
        content.innerHTML = `
            <div class="order-details">
                <div class="order-summary">
                    <div class="summary-item">
                        <strong>–ó–∞–∫–∞–∑ #${order.id}</strong>
                        <span class="status-badge ${order.status}">${order.status}</span>
                    </div>
                    <div class="summary-item">
                        <strong>–°—Ç–æ–ª:</strong> ${order.table_number}
                    </div>
                    <div class="summary-item">
                        <strong>–ì–æ—Å—Ç–µ–π:</strong> 
                        <input type="number" 
                            id="guestCountInput" 
                            value="${order.guest_count}" 
                            min="1" 
                            max="${order.table ? order.table.capacity : 20}" 
                            class="form-control guest-count-input">
                        <button class="btn btn-sm btn-primary" onclick="updateGuestCount(${order.id})">–û–±–Ω–æ–≤–∏—Ç—å</button>
                    </div>
                    <div class="summary-item">
                        <strong>–í—Ä–µ–º—è:</strong> ${new Date(order.created_at).toLocaleTimeString()}
                    </div>
                    ${order.bonus_card ? `
                    <div class="summary-item bonus-card-info">
                        <strong>–ë–æ–Ω—É—Å–Ω–∞—è –∫–∞—Ä—Ç–∞:</strong> 
                        <span class="bonus-card-number">${order.bonus_card.card_number}</span>
                        <span class="bonus-card-discount">(${order.bonus_card.discount_percent}% —Å–∫–∏–¥–∫–∞)</span>
                    </div>
                    ` : ''}
                </div>
                
                <div class="order-items">
                    ${itemsHtml}
                </div>
                
                <div class="order-total">
                    <div class="total-item">
                        <strong>–ü–æ–¥—ã—Ç–æ–≥:</strong> ${order.subtotal} TMT
                    </div>
                    <div class="total-item">
                        <strong>–°–µ—Ä–≤–∏—Å–Ω—ã–π —Å–±–æ—Ä:</strong> ${order.service_charge} TMT
                    </div>
                    ${order.discount_amount > 0 ? `
                    <div class="total-item discount-item">
                        <strong>–°–∫–∏–¥–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ (${order.discount_percent}%):</strong> -${order.discount_amount} TMT
                    </div>
                    ` : ''}
                    <div class="total-item total-final">
                        <strong>–ò–¢–û–ì–û:</strong> ${(parseFloat(order.subtotal) + parseFloat(order.service_charge) - parseFloat(order.discount_amount || 0)).toFixed(2)} TMT
                    </div>
                </div>
            </div>
        `;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
        const applyBonusCardButton = document.getElementById('applyBonusCard');
        
        if (order.status === 'pending') {
            printButton.style.display = 'inline-block';
            finalReceiptButton.style.display = 'none';
            applyBonusCardButton.style.display = 'inline-block';
        } else if (order.status === 'confirmed') {
            // –í confirmed –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –Ω–∞ –ø–µ—á–∞—Ç—å –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –µ—Å—Ç—å –¥–æ–ø. –ø–æ–∑–∏—Ü–∏–∏
            if (order.has_added_items) {
                printButton.style.display = 'inline-block';
                printButton.disabled = false;
            } else {
                printButton.style.display = 'inline-block';
                printButton.disabled = true;
            }
            // –ò—Ç–æ–≥–æ–≤—ã–π —á–µ–∫ –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–µ–Ω
            finalReceiptButton.style.display = 'inline-block';
            applyBonusCardButton.style.display = 'none';
        } else {
            printButton.style.display = 'none';
            finalReceiptButton.style.display = 'none';
            applyBonusCardButton.style.display = 'none';
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –∑–∞–∫–∞–∑–∞ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
        modal.dataset.orderId = order.id;
        modal.style.display = 'block';
        modal.classList.add('show', 'visible');
        modal.classList.remove('hidden');
        modal.setAttribute('aria-modal', 'true');
        modal.removeAttribute('aria-hidden');
        modalState.orderDetailOpen = true;
        
        console.log('‚úÖ –ú–æ–¥–∞–ª–∫–∞ –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–∞ #' + order.id + ' –æ—Ç–∫—Ä—ã—Ç–∞');
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è HTML –ø–æ–∑–∏—Ü–∏–∏
    function createItemHtml(item, orderId) {
        return `
            <div class="order-item" data-item-id="${item.id}">
                <div class="item-header">
                    <span class="item-quantity">${item.quantity}x</span>
                    <span class="item-name">${item.name}</span>
                    <span class="item-price">${item.unit_price} TMT</span>
                </div>
                <div class="item-comments-section">
                    <textarea 
                        class="form-control comment-textarea" 
                        placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –±–ª—é–¥—É..."
                        onchange="updateItemComment(${orderId}, ${item.id}, this.value)"
                    >${item.comments || ''}</textarea>
                </div>
            </div>
        `;
    }

    // ========= –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ü–ï–ß–ê–¢–ò –ò–ó –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê =========
    function printOrderReceipts() {
        console.log('üîß printOrderReceipts –≤—ã–∑–≤–∞–Ω–∞');
        const modal = document.getElementById('orderDetailModal');
        const orderId = modal.dataset.orderId;
        
        if (!orderId) {
            waiterNotifications.showError('ID –∑–∞–∫–∞–∑–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        
        const printButton = document.getElementById('printOrderReceipts');
        const originalText = printButton.textContent;
        printButton.textContent = '–ü–µ—á–∞—Ç—å...';
        printButton.disabled = true;
        
        fetch(`/waiter/api/orders/${orderId}/print`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                console.log('‚úÖ –ü–µ—á–∞—Ç—å —É—Å–ø–µ—à–Ω–∞');
                waiterNotifications.showSuccess('–ß–µ–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ –ø–µ—á–∞—Ç—å!');
                
                // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                // –ü—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
                document.getElementById('printFinalReceipt').style.display = 'inline-block';
                printButton.style.display = 'none';
                

                
                console.log('üîç –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É —á–µ—Ä–µ–∑ 1.5 —Å–µ–∫—É–Ω–¥—ã');
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤
                setTimeout(() => {
                    console.log('ÔøΩÔøΩ –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏');
                    closeAllModals();
                    
                    console.log('üîç –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ –ø–æ—Å–ª–µ –ø–µ—á–∞—Ç–∏');
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ –ø–æ—Å–ª–µ –ø–µ—á–∞—Ç–∏
                    loadOrders();
                }, 1500); // –î–∞–µ–º –≤—Ä–µ–º—è –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            } else {
                waiterNotifications.showError(data.message || '–û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏');
            }
        })
        .catch(error => {
            console.error('Error printing receipts:', error);
            waiterNotifications.showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
        })
        .finally(() => {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            printButton.textContent = originalText;
            printButton.disabled = false;
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –±–æ–Ω—É—Å–Ω–æ–π –∫–∞—Ä—Ç—ã
    function applyBonusCard() {
        const modal = document.getElementById('orderDetailModal');
        const orderId = modal.dataset.orderId;
        
        if (!orderId) {
            waiterNotifications.showError('ID –∑–∞–∫–∞–∑–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã
        const cardNumber = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –±–æ–Ω—É—Å–Ω–æ–π –∫–∞—Ä—Ç—ã (6 —Ü–∏—Ñ—Ä):');
        
        if (!cardNumber) {
            return;
        }
        
        if (cardNumber.length !== 6 || !/^\d+$/.test(cardNumber)) {
            waiterNotifications.showError('–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 6 —Ü–∏—Ñ—Ä');
            return;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const applyButton = document.getElementById('applyBonusCard');
        const originalText = applyButton.textContent;
        applyButton.textContent = '–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ...';
        applyButton.disabled = true;
        
        fetch(`/api/bonus-cards/apply/${orderId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                card_number: cardNumber
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                waiterNotifications.showSuccess(data.message);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
                viewOrderDetails(orderId);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –∑–∞–∫–∞–∑–∞ –≤ —Å–ø–∏—Å–∫–µ
                updateOrderCardInList(orderId, data.data.order);
                
            } else {
                waiterNotifications.showError(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∫–∞—Ä—Ç—ã');
            }
        })
        .catch(error => {
            console.error('Error applying bonus card:', error);
            waiterNotifications.showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
        })
        .finally(() => {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            applyButton.textContent = originalText;
            applyButton.disabled = false;
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–µ—á–∞—Ç–∏ —á–µ–∫–æ–≤ –∑–∞–∫–∞–∑–∞ (–¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ –∑–∞–∫–∞–∑–∞)
    function printOrderReceiptsFromCard(orderId) {
        console.log('ÔøΩÔøΩ printOrderReceiptsFromCard –≤—ã–∑–≤–∞–Ω–∞ –¥–ª—è –∑–∞–∫–∞–∑–∞ #' + orderId);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const printButton = event.target;
        const originalText = printButton.innerHTML;
        printButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ü–µ—á–∞—Ç—å...';
        printButton.disabled = true;
        
        fetch(`/waiter/api/orders/${orderId}/print`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                console.log('ÔøΩÔøΩ –ü–µ—á–∞—Ç—å —É—Å–ø–µ—à–Ω–∞ –¥–ª—è –∑–∞–∫–∞–∑–∞ #' + orderId);
                waiterNotifications.showSuccess('–ß–µ–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ –ø–µ—á–∞—Ç—å!');
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –±—ã–ª –ª–∏ —ç—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥ –∏–∑ pending –≤ confirmed –∏–ª–∏ –ø–µ—á–∞—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π
                const orderCard = document.querySelector(`[data-order-id="${orderId}"]`);
                const currentStatus = orderCard ? orderCard.querySelector('.order-status')?.textContent.toLowerCase() : '';
                
                console.log('üîç –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞:', currentStatus);
                
                // –ï—Å–ª–∏ –∑–∞–∫–∞–∑ –±—ã–ª pending - –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ confirmed
                if (currentStatus.includes('pending') || currentStatus.includes('–Ω–æ–≤—ã–π')) {
                    console.log('ÔøΩÔøΩ –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å pending –Ω–∞ confirmed');
                    if (orderCard) {
                        const statusElement = orderCard.querySelector('.order-status');
                        if (statusElement) {
                            const statusInfo = statusReference['confirmed'];
                            if (statusInfo) {
                                statusElement.textContent = `${statusInfo.icon} ${statusInfo.name.toUpperCase()}`;
                                statusElement.style.background = statusInfo.color;
                            } else {
                                // Fallback –µ—Å–ª–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
                                const statusIcon = getStatusIcon('confirmed');
                                const statusColor = getStatusColor('confirmed');
                                statusElement.textContent = `${statusIcon} CONFIRMED`;
                                statusElement.style.background = statusColor;
                            }
                            statusElement.className = 'order-status confirmed';
                        }
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è confirmed —Å—Ç–∞—Ç—É—Å–∞
                        const actionsContainer = orderCard.querySelector('.order-actions');
                        if (actionsContainer) {
                            actionsContainer.innerHTML = `
                                <button class="btn btn-primary" onclick="window.viewOrderDetails(${orderId})">
                                    <i class="fas fa-eye"></i> –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏
                                </button>
                                <button class="btn btn-success" disabled onclick="window.updateOrderStatus(${orderId})">
                                    <i class="fas fa-check"></i> –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–π
                                </button>
                                <button class="btn btn-warning" onclick="window.addMoreItems(${orderId})">
                                    <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å
                                </button>
                                <button class="btn btn-danger" onclick="window.cancelOrder(${orderId})">
                                    <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑
                                </button>
                            `;
                        }
                    }
                }
                
                console.log('üîç –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤');
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤
                loadOrders();
            } else {
                waiterNotifications.showError(data.message || '–û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏');
            }
        })
        .catch(error => {
            console.error('Error printing receipts:', error);
            waiterNotifications.showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
        })
        .finally(() => {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            printButton.innerHTML = originalText;
            printButton.disabled = false;
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–µ—á–∞—Ç–∏ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —á–µ–∫–∞
    function printFinalReceipt() {
        const modal = document.getElementById('orderDetailModal');
        const orderId = modal.dataset.orderId;
        
        if (!orderId) {
            waiterNotifications.showError('ID –∑–∞–∫–∞–∑–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const printButton = document.getElementById('printFinalReceipt');
        const originalText = printButton.textContent;
        printButton.textContent = '–ü–µ—á–∞—Ç—å...';
        printButton.disabled = true;
        
        fetch(`/waiter/api/orders/${orderId}/print-final`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                waiterNotifications.showSuccess('–§–∏–Ω–∞–ª—å–Ω—ã–π —á–µ–∫ –Ω–∞–ø–µ—á–∞—Ç–∞–Ω!');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
                const statusBadge = document.querySelector('.status-badge');
                if (statusBadge) {
                    statusBadge.textContent = 'completed';
                    statusBadge.className = 'status-badge completed';
                }
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–µ—á–∞—Ç–∏
                printButton.style.display = 'none';
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤
                setTimeout(() => {
                    closeAllModals();
                    loadOrders(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤
                }, 1500); // –î–∞–µ–º –≤—Ä–µ–º—è –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            } else {
                waiterNotifications.showError(data.message || '–û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —á–µ–∫–∞');
            }
        })
        .catch(error => {
            console.error('Error printing final receipt:', error);
            waiterNotifications.showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
        })
        .finally(() => {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            printButton.textContent = originalText;
            printButton.disabled = false;
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–µ—á–∞—Ç–∏
    function showPrintStatus(printData) {
        const modal = document.getElementById('printStatusModal');
        const content = document.getElementById('printStatusContent');
        
        let statusHtml = '<div class="print-status">';
        
        if (printData.kitchen_printed) {
            statusHtml += '<div class="status-item success">‚úÖ –ö—É—Ö–æ–Ω–Ω—ã–π —á–µ–∫ –Ω–∞–ø–µ—á–∞—Ç–∞–Ω</div>';
        } else {
            statusHtml += '<div class="status-item error">‚ùå –û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏ –∫—É—Ö–æ–Ω–Ω–æ–≥–æ —á–µ–∫–∞</div>';
        }
        
        if (printData.bar_printed) {
            statusHtml += '<div class="status-item success">‚úÖ –ë–∞—Ä–Ω—ã–π —á–µ–∫ –Ω–∞–ø–µ—á–∞—Ç–∞–Ω</div>';
        } else {
            statusHtml += '<div class="status-item error">‚ùå –û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏ –±–∞—Ä–Ω–æ–≥–æ —á–µ–∫–∞</div>';
        }
        
        statusHtml += `<div class="status-summary">
            <p>–ö—É—Ö–æ–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π: ${printData.kitchen_items_count}</p>
            <p>–ë–∞—Ä–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π: ${printData.bar_items_count}</p>
        </div>`;
        
        statusHtml += '</div>';
        content.innerHTML = statusHtml;
        
        modal.style.display = 'block';
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∫–∏
    document.addEventListener('DOMContentLoaded', function() {
        console.log(' DOMContentLoaded - –Ω–∞—á–∞–ª–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –º–æ–¥–∞–ª–∫–∏');
        
        // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        registerEventHandlers();
        
        console.log(' DOMContentLoaded - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
    });

    // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å
    window.updateOrderStatus = updateOrderStatus;
    window.viewOrderDetails = viewOrderDetails;
    window.closeOrderModal = closeOrderModal;
    window.closeAddItemsModal = closeAddItemsModal;
    window.printOrderReceipts = printOrderReceipts;
    window.printOrderReceiptsFromCard = printOrderReceiptsFromCard;
    window.printFinalReceipt = printFinalReceipt;
    window.applyBonusCard = applyBonusCard;
    window.cancelOrder = cancelOrder;
    window.updateGuestCount = updateGuestCount;
    window.updateItemComment = updateItemComment;

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    document.getElementById('refreshOrders').addEventListener('click', loadOrders);
    document.getElementById('statusFilter').addEventListener('change', loadOrders);
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–µ—á–∞—Ç–∏
    document.getElementById('printOrderReceipts').addEventListener('click', printOrderReceipts);
    document.getElementById('printFinalReceipt').addEventListener('click', printFinalReceipt);
    document.getElementById('applyBonusCard').addEventListener('click', applyBonusCard);
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
    document.querySelectorAll('[data-dismiss="modal"]').forEach(button => {
        button.addEventListener('click', function() {
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–∞—è –º–æ–¥–∞–ª–∫–∞ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è
            if (this.closest('#orderDetailModal')) {
                closeAllModals();
            } else if (this.closest('#addItemsModal')) {
                closeAddItemsModal();
            } else {
                // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –¥–ª—è –¥—Ä—É–≥–∏—Ö –º–æ–¥–∞–ª–æ–∫
                const modal = this.closest('.modal');
                if (modal) {
                    modal.classList.remove('visible');
                    modal.classList.add('hidden');
                }
            }
        });
    });
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫—É –≤–Ω–µ –∏—Ö
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                const orderId = this.dataset.orderId;
                
                if (this.id === 'orderDetailModal') {
                    console.log('üîç –ú–æ–¥–∞–ª–∫–∞ "–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞" –¥–ª—è –∑–∞–∫–∞–∑–∞ #' + (orderId || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ') + ' –ó–ê–ö–†–´–¢–ê (–∫–ª–∏–∫ –≤–Ω–µ –º–æ–¥–∞–ª–∫–∏)');
                    closeAllModals();
                } else if (this.id === 'addItemsModal') {
                    console.log('üîç –ú–æ–¥–∞–ª–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏–∏" –¥–ª—è –∑–∞–∫–∞–∑–∞ #' + (orderId || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ') + ' –ó–ê–ö–†–´–¢–ê (–∫–ª–∏–∫ –≤–Ω–µ –º–æ–¥–∞–ª–∫–∏)');
                    closeAddItemsModal();
                } else {
                    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –¥–ª—è –¥—Ä—É–≥–∏—Ö –º–æ–¥–∞–ª–æ–∫
                    this.classList.remove('visible');
                    this.classList.add('hidden');
                }
            }
        });
    });
    
             // –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
    loadOrders();
    
    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ –∑–∞–∫–∞–∑–∞ –≤ —Å–ø–∏—Å–∫–µ
    function updateOrderCardInList(orderId, updatedOrder) {
        const orderCard = document.querySelector(`[data-order-id="${orderId}"]`);
        if (!orderCard) {
            console.warn(`Order card with ID ${orderId} not found in list`);
            return;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É –≤ –∫–∞—Ä—Ç–æ—á–∫–µ
        const totalAmountElement = orderCard.querySelector('.total-amount');
        if (totalAmountElement) {
            const newTotal = (parseFloat(updatedOrder.subtotal) + parseFloat(updatedOrder.service_charge) - parseFloat(updatedOrder.discount_amount || 0)).toFixed(2);
            totalAmountElement.textContent = `${newTotal} TMT`;
        }
        
    }
    
    // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    function createPaginationControls(pagination) {
        if (pagination.pages <= 1) return '';
        
        let paginationHtml = '<div class="pagination-controls">';
        
        if (pagination.has_prev) {
            paginationHtml += `<button class="btn btn-secondary" onclick="loadOrders(${pagination.prev_num})">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è</button>`;
        }
        
        for (let i = 1; i <= pagination.pages; i++) {
            if (i === pagination.page) {
                paginationHtml += `<span class="current-page">${i}</span>`;
            } else {
                paginationHtml += `<button class="btn btn-outline-secondary" onclick="loadOrders(${i})">${i}</button>`;
            }
        }
        
        if (pagination.has_next) {
            paginationHtml += `<button class="btn btn-secondary" onclick="loadOrders(${pagination.next_num})">–°–ª–µ–¥—É—é—â–∞—è ‚Üí</button>`;
        }
        
        paginationHtml += '</div>';
        return paginationHtml;
    }

    // ========= –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ó–ê–ö–†–´–¢–ò–Ø –ú–û–î–ê–õ–¨–ù–´–• –û–ö–û–ù =========
    
    // –ö–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è
    document.querySelectorAll('[data-dismiss="modal"]').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            closeAllModals();
        });
    });
    
    // –ö–ª–∏–∫ –ø–æ backdrop
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeAllModals();
            }
        });
    });
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            if (modalState.orderDetailOpen || modalState.addItemsOpen) {
                closeAllModals();
            }
        }
    });

    // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å
    window.updateOrderStatus = updateOrderStatus;
    window.viewOrderDetails = viewOrderDetails;
    window.printOrderReceipts = printOrderReceipts;
    window.printFinalReceipt = printFinalReceipt;
    window.applyBonusCard = applyBonusCard;
    window.cancelOrder = cancelOrder;
    window.updateGuestCount = updateGuestCount;
    window.updateItemComment = updateItemComment;
    window.loadOrders = loadOrders;

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
    document.getElementById('refreshOrders').addEventListener('click', () => loadOrders());
    document.getElementById('statusFilter').addEventListener('change', () => loadOrders());
    document.getElementById('printOrderReceipts').addEventListener('click', printOrderReceipts);
    document.getElementById('printFinalReceipt').addEventListener('click', printFinalReceipt);
    document.getElementById('applyBonusCard').addEventListener('click', applyBonusCard);
    
    // –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
    setTimeout(() => {
        loadOrders();
    }, 100);
    
});
</script>
{% endblock %}