{% extends "waiter/base.html" %}

{% block title %}–ó–∞–∫–∞–∑—ã - –û—Ñ–∏—Ü–∏–∞–Ω—Ç - DENIZ Restaurant{% endblock %}

{% block content %}
<style>
/* –°—Ç–∏–ª–∏ –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –∑–∞–∫–∞–∑–æ–≤ */
.status-group {
    margin-bottom: 2rem;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    overflow: hidden;
}

.status-group-title {
    margin: 0;
    padding: 1rem;
    font-size: 1.2rem;
    font-weight: 600;
    color: #333;
}

.pending-title {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
}

.confirmed-title {
    background: linear-gradient(135deg, #ffc107, #e0a800);
    color: black;
}

.completed-title {
    background: linear-gradient(135deg, #6c757d, #495057);
    color: white;
}

.cancelled-title {
    background: linear-gradient(135deg, #dc3545, #c82333);
    color: white;
}

.status-group .order-card {
    border: none;
    border-radius: 0;
    margin: 0;
    border-bottom: 1px solid #f0f0f0;
}

.status-group .order-card:last-child {
    border-bottom: none;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞–∫–∞–∑–æ–≤ */
.order-status {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    color: white;
    font-weight: 600;
    font-size: 0.9rem;
    text-transform: uppercase;
}

.order-close-btn {
    color: black;
    font-size: 1.5rem;
    font-weight: 600;
    cursor: pointer;
    width: 60px;
    border-radius: 15px;
}

.order-status.pending {
    background: #28a745 !important;
}

.order-status.completed {
    background: #6c757d !important;
}

.order-status.cancelled {
    background: #dc3545 !important;
}

.order-status.confirmed {
    background: #ffc107 !important;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π */
.btn-success {
    background-color: #28a745;
    border-color: #28a745;
    color: white;
}

.btn-info {
    background-color: #17a2b8;
    border-color: #17a2b8;
    color: white;
}



.btn-secondary {
    background-color: #6c757d;
    border-color: #6c757d;
    color: white;
}

.btn-danger {
    background-color: #dc3545;
    border-color: #dc3545;
    color: white;
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å–ø–∏–Ω–Ω–µ—Ä–∞ */
.fa-spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<div class="orders-container">
    <div class="page-header">
        <h1>–ó–∞–∫–∞–∑—ã</h1>
        <div class="header-actions">
            <button class="btn btn-secondary" id="refreshOrders">
                <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
            </button>
        </div>
    </div>

    <div class="orders-filters">
        <div class="filter-group">
            <label>–°—Ç–∞—Ç—É—Å:</label>
            <select id="statusFilter" class="form-control">
                <option value="">–í—Å–µ</option>
                <option value="pending">–ù–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã</option>
                <option value="confirmed">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã</option>
                <option value="completed">–û–ø–ª–∞—á–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã</option>
                <option value="cancelled">–û—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã</option>
            </select>
        </div>
        <div class="filter-group">
            <label>–°—Ç–æ–ª:</label>
            <select id="tableFilter" class="form-control">
                <option value="">–í—Å–µ —Å—Ç–æ–ª—ã</option>
            </select>
        </div>
    </div>

    <div class="orders-list" id="ordersList">
        <div class="loading-placeholder">
            <div class="spinner"></div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</p>
        </div>
    </div>

    <!-- Order Detail Modal -->
    <div class="modal modal-overlay hidden" id="orderDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞</h3>
                <button type="button" class="order-close-btn" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body" id="orderDetailContent">
                <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button type="button" class="btn btn-info" id="applyBonusCard" style="display: none;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–∞—Ä—Ç—É</button>
                <button type="button" class="btn btn-primary" id="printOrderReceipts">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø–µ—á–∞—Ç—å</button>
                <button type="button" class="btn btn-success" id="printFinalReceipt" style="display: none;">–ü–µ—á–∞—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —á–µ–∫–∞</button>
            </div>
        </div>
    </div>

    <!-- Print Status Modal -->
    <div class="modal modal-overlay hidden" id="printStatusModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–°—Ç–∞—Ç—É—Å –ø–µ—á–∞—Ç–∏</h3>
                <button type="button" class="btn-close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="printStatusContent">
                    <!-- –°—Ç–∞—Ç—É—Å –ø–µ—á–∞—Ç–∏ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// CSRF —Ç–æ–∫–µ–Ω –¥–ª—è AJAX –∑–∞–ø—Ä–æ—Å–æ–≤
const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

// –û–±—ä—è–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ
let updateOrderStatus, viewOrderDetails, printOrderReceipts, printFinalReceipt, applyBonusCard;

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤
let statusReference = {};

document.addEventListener('DOMContentLoaded', function() {
    console.log('üìã Orders page initialized');
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Å—Ç–∞—Ç—É—Å–æ–≤
    loadStatusReference();
    
    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤
    async function loadStatusReference() {
        try {
            console.log('üìö –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Å—Ç–∞—Ç—É—Å–æ–≤...');
            const response = await fetch('/waiter/api/order-statuses');
            const data = await response.json();
            
            if (data.status === 'success') {
                statusReference = {};
                data.data.forEach(status => {
                    statusReference[status.code] = status;
                });
                console.log('‚úÖ –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω:', statusReference);
            } else {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤:', data.message);
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤:', error);
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤
    async function loadOrders() {
        try {
            const statusFilter = document.getElementById('statusFilter').value;
            const tableFilter = document.getElementById('tableFilter').value;
            
            const filters = {};
            if (statusFilter) filters.status = statusFilter;
            if (tableFilter) filters.table_id = tableFilter;
            
            const ordersList = document.getElementById('ordersList');
            ordersList.innerHTML = '<div class="loading-placeholder"><div class="spinner"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</p></div>';
            
            // –ü–æ–ª—É—á–∞–µ–º –∑–∞–∫–∞–∑—ã —á–µ—Ä–µ–∑ API
            const response = await window.WaiterAPI.getOrders(filters);
            
            if (response.status === 'success' && response.data.orders.length > 0) {
                console.log(`üìä –ü–æ–ª—É—á–µ–Ω–æ ${response.data.orders.length} –∑–∞–∫–∞–∑–æ–≤`);
                console.log(`üìã –°—Ç–∞—Ç—É—Å—ã –∑–∞–∫–∞–∑–æ–≤:`, response.data.orders.map(o => ({id: o.id, status: o.status})));
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∑–∞–∫–∞–∑—ã: —Å–Ω–∞—á–∞–ª–∞ pending, –ø–æ—Ç–æ–º confirmed, –ø–æ—Ç–æ–º completed, –ø–æ—Ç–æ–º cancelled
                const sortedOrders = response.data.orders.sort((a, b) => {
                    const statusOrder = { 'pending': 1, 'confirmed': 2, 'completed': 3, 'cancelled': 4 };
                    const aOrder = statusOrder[a.status] || 5;
                    const bOrder = statusOrder[b.status] || 5;
                    
                    if (aOrder !== bOrder) {
                        return aOrder - bOrder;
                    }
                    
                    // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å—ã –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ, —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–¥–∞–Ω–∏—è (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏)
                    return new Date(b.created_at) - new Date(a.created_at);
                });
                
                // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∑–∞–∫–∞–∑—ã –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
                const ordersByStatus = {
                    pending: [],
                    confirmed: [],
                    completed: [],
                    cancelled: []
                };
                
                sortedOrders.forEach(order => {
                    if (ordersByStatus[order.status]) {
                        ordersByStatus[order.status].push(order);
                    }
                });
                
                console.log(`üìä –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞: pending=${ordersByStatus.pending.length}, confirmed=${ordersByStatus.confirmed.length}, completed=${ordersByStatus.completed.length}, cancelled=${ordersByStatus.cancelled.length}`);
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∑–∞–∫–∞–∑—ã —Å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π
                let ordersHtml = '';
                
                // Pending –∑–∞–∫–∞–∑—ã (–Ω–æ–≤—ã–µ) - –∑–µ–ª–µ–Ω—ã–π —Ü–≤–µ—Ç
                if (ordersByStatus.pending.length > 0) {
                    console.log(`üìã –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º ${ordersByStatus.pending.length} pending –∑–∞–∫–∞–∑–æ–≤`);
                    const statusInfo = statusReference['pending'] || { name: '–ù–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã', icon: 'üü¢' };
                    ordersHtml += '<div class="status-group pending-group">';
                    ordersHtml += `<h3 class="status-group-title pending-title">${statusInfo.icon} ${statusInfo.name}</h3>`;
                    ordersByStatus.pending.forEach(order => {
                        ordersHtml += createOrderCard(order);
                    });
                    ordersHtml += '</div>';
                }
                
                // Confirmed –∑–∞–∫–∞–∑—ã (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ) - –∂–µ–ª—Ç—ã–π —Ü–≤–µ—Ç
                if (ordersByStatus.confirmed.length > 0) {
                    console.log(`üìã –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º ${ordersByStatus.confirmed.length} confirmed –∑–∞–∫–∞–∑–æ–≤`);
                    const statusInfo = statusReference['confirmed'] || { name: '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã', icon: '‚úÖ' };
                    ordersHtml += '<div class="status-group confirmed-group">';
                    ordersHtml += `<h3 class="status-group-title confirmed-title">${statusInfo.icon} ${statusInfo.name}</h3>`;
                    ordersByStatus.confirmed.forEach(order => {
                        ordersHtml += createOrderCard(order);
                    });
                    ordersHtml += '</div>';
                }
                
                // Completed –∑–∞–∫–∞–∑—ã (–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ) - —Å–µ—Ä—ã–π —Ü–≤–µ—Ç
                if (ordersByStatus.completed.length > 0) {
                    console.log(`üìã –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º ${ordersByStatus.completed.length} completed –∑–∞–∫–∞–∑–æ–≤`);
                    const statusInfo = statusReference['completed'] || { name: '–û–ø–ª–∞—á–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã', icon: '‚ö´' };
                    ordersHtml += '<div class="status-group completed-group">';
                    ordersHtml += `<h3 class="status-group-title completed-title">${statusInfo.icon} ${statusInfo.name}</h3>`;
                    ordersByStatus.completed.forEach(order => {
                        ordersHtml += createOrderCard(order);
                    });
                    ordersHtml += '</div>';
                }
                
                // Cancelled –∑–∞–∫–∞–∑—ã (–æ—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ) - –∫—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç
                if (ordersByStatus.cancelled.length > 0) {
                    console.log(`üìã –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º ${ordersByStatus.cancelled.length} cancelled –∑–∞–∫–∞–∑–æ–≤`);
                    const statusInfo = statusReference['cancelled'] || { name: '–û—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã', icon: '‚ùå' };
                    ordersHtml += '<div class="status-group cancelled-group">';
                    ordersHtml += `<h3 class="status-group-title cancelled-title">${statusInfo.icon} ${statusInfo.name}</h3>`;
                    ordersByStatus.cancelled.forEach(order => {
                        ordersHtml += createOrderCard(order);
                    });
                    ordersHtml += '</div>';
                }
                
                ordersList.innerHTML = ordersHtml;
            } else {
                // –ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤
                ordersList.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-clipboard-list"></i>
                        <h3>–ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                        <p>–í –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∏–ª—å—Ç—Ä–∞–º</p>
                    </div>
                `;
            }
            
        } catch (error) {
            console.error('Error loading orders:', error);
            waiterNotifications.showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤');
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ –∑–∞–∫–∞–∑–∞
    function createOrderCard(order) {
        console.log(`üé® –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –¥–ª—è –∑–∞–∫–∞–∑–∞ ${order.id} —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º ${order.status}`);
        const statusColor = getStatusColor(order.status);
        const statusIcon = getStatusIcon(order.status);
        
        console.log(`üé® –°—Ç–∞—Ç—É—Å: ${order.status}, —Ü–≤–µ—Ç: ${statusColor}, –∏–∫–æ–Ω–∫–∞: ${statusIcon}`);
        
        return `
            <div class="order-card" data-order-id="${order.id}">
                <div class="order-header">
                    <div class="order-info">
                        <div class="order-title">
                            <h3>–ó–∞–∫–∞–∑ #${order.id}</h3>
                            <span class="order-status ${order.status}" style="background: ${statusColor};">
                                ${statusIcon} ${order.status.toUpperCase()}
                            </span>
                        </div>
                        <div class="order-table-info">
                            <i class="fas fa-table"></i>
                            <span>–°—Ç–æ–ª: ${order.table_number}</span>
                            <i class="fas fa-users"></i>
                            <span>–ì–æ—Å—Ç–µ–π: ${order.guest_count}</span>
                        </div>
                    </div>
                </div>
                <div class="order-body">
                    <div class="order-total">
                        <div class="total-label">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</div>
                        <div class="total-amount">${order.total_amount} TMT</div>
                    </div>
                    <div class="order-meta">
                        <div class="meta-item">
                            <i class="fas fa-clock"></i>
                            <span>–°–æ–∑–¥–∞–Ω: ${new Date(order.created_at).toLocaleString('ru-RU')}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-language"></i>
                            <span>–Ø–∑—ã–∫: ${order.language.toUpperCase()}</span>
                        </div>
                    </div>
                </div>
                <div class="order-actions">
                    <button class="btn btn-primary" onclick="window.viewOrderDetails(${order.id})">
                        <i class="fas fa-eye"></i> –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏
                    </button>
                    ${order.status === 'pending' ? `
                        <button class="btn btn-info" onclick="window.printOrderReceiptsFromCard(${order.id})">
                            <i class="fas fa-print"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø–µ—á–∞—Ç—å
                        </button>
                        <button class="btn btn-danger" onclick="window.cancelOrder(${order.id})">
                            <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑
                        </button>
                    ` : order.status === 'confirmed' ? `
                        <button class="btn btn-success" onclick="window.updateOrderStatus(${order.id})">
                            <i class="fas fa-check"></i> –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–π
                        </button>
                        <button class="btn btn-danger" onclick="window.cancelOrder(${order.id})">
                            <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑
                        </button>
                    ` : order.status === 'completed' ? `
                        <button class="btn btn-secondary" disabled>
                            <i class="fas fa-check"></i> –ó–∞–∫–∞–∑ –æ–ø–ª–∞—á–µ–Ω
                        </button>
                    ` : order.status === 'cancelled' ? `
                        <button class="btn btn-secondary" disabled>
                            <i class="fas fa-times"></i> –ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω
                        </button>
                    ` : ''}
                </div>
            </div>
        `;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ —Å—Ç–∞—Ç—É—Å–∞ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞
    function getStatusColor(status) {
        if (statusReference[status] && statusReference[status].color) {
            return statusReference[status].color;
        }
        // Fallback —Ü–≤–µ—Ç–∞
        const fallbackColors = {
            'pending': '#28a745',    // –ó–µ–ª–µ–Ω—ã–π
            'confirmed': '#ffc107',  // –ñ–µ–ª—Ç—ã–π
            'completed': '#6c757d',  // –°–µ—Ä—ã–π
            'cancelled': '#dc3545'   // –ö—Ä–∞—Å–Ω—ã–π
        };
        return fallbackColors[status] || '#6c757d';
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∫–æ–Ω–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞
    function getStatusIcon(status) {
        if (statusReference[status] && statusReference[status].icon) {
            return statusReference[status].icon;
        }
        // Fallback –∏–∫–æ–Ω–∫–∏
        const fallbackIcons = {
            'pending': 'üü¢',
            'confirmed': '‚úÖ',
            'completed': '‚ö´',
            'cancelled': '‚ùå'
        };
        return fallbackIcons[status] || '‚ö´';
    }
    
    // –§—É–Ω–∫—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞
    function updateOrderStatus(orderId) {
        console.log(`üîÑ updateOrderStatus –≤—ã–∑–≤–∞–Ω–∞ –¥–ª—è –∑–∞–∫–∞–∑–∞ ${orderId}`);
        
        // –ù–∞—Ö–æ–¥–∏–º –∑–∞–∫–∞–∑ –≤ —Å–ø–∏—Å–∫–µ
        const orderCards = document.querySelectorAll('.order-card');
        console.log(`üìã –ù–∞–π–¥–µ–Ω–æ ${orderCards.length} –∫–∞—Ä—Ç–æ—á–µ–∫ –∑–∞–∫–∞–∑–æ–≤`);
        
        let currentOrder = null;
        
        orderCards.forEach(card => {
            console.log(`üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É:`, card.dataset.orderId, 'vs', orderId);
            if (card.dataset.orderId == orderId) {
                currentOrder = card;
                console.log(`‚úÖ –ù–∞–π–¥–µ–Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞ –∑–∞–∫–∞–∑–∞ ${orderId}`);
            }
        });
        
        if (!currentOrder) {
            console.error(`‚ùå –ö–∞—Ä—Ç–æ—á–∫–∞ –∑–∞–∫–∞–∑–∞ ${orderId} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞`);
            waiterNotifications.showError('–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –∏–∑ DOM
        const statusElement = currentOrder.querySelector('.order-status');
        console.log(`üîç –≠–ª–µ–º–µ–Ω—Ç —Å—Ç–∞—Ç—É—Å–∞:`, statusElement);
        
        if (!statusElement) {
            console.error(`‚ùå –≠–ª–µ–º–µ–Ω—Ç —Å—Ç–∞—Ç—É—Å–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –∑–∞–∫–∞–∑–∞ ${orderId}`);
            waiterNotifications.showError('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞');
            return;
        }
        
        const currentStatus = statusElement.textContent.trim();
        console.log(`üìä –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ ${orderId}: "${currentStatus}"`);
        
        let newStatus;
        let actionText;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å, –∏–≥–Ω–æ—Ä–∏—Ä—É—è —ç–º–æ–¥–∑–∏ –∏ –ø—Ä–æ–±–µ–ª—ã
        const cleanStatus = currentStatus.replace(/[üü¢‚ö´üî¥‚úÖ‚ùå]/g, '').trim().toLowerCase();
        console.log(`üßπ –û—á–∏—â–µ–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å: "${cleanStatus}"`);
        
        // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º —Å—Ç–∞—Ç—É—Å–µ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞
        const currentStatusInfo = statusReference[cleanStatus];
        if (!currentStatusInfo) {
            console.error(`‚ùå –°—Ç–∞—Ç—É—Å "${cleanStatus}" –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ`);
            waiterNotifications.showError('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞');
            return;
        }
        
        console.log(`üìö –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ:`, currentStatusInfo);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Å—Ç–∞—Ç—É—Å—É completed
        if (canTransitionTo(cleanStatus, 'completed')) {
            newStatus = 'completed';
            actionText = '–æ—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–π';
            console.log(`‚úÖ –ü–µ—Ä–µ—Ö–æ–¥ —Ä–∞–∑—Ä–µ—à–µ–Ω: ${cleanStatus} ‚Üí ${newStatus}`);
        } else if (cleanStatus === 'completed') {
            console.log(`‚ÑπÔ∏è –ó–∞–∫–∞–∑ —É–∂–µ completed`);
            waiterNotifications.showInfo('–ó–∞–∫–∞–∑ —É–∂–µ –æ–ø–ª–∞—á–µ–Ω');
            return;
        } else if (cleanStatus === 'cancelled') {
            console.log(`‚ÑπÔ∏è –ó–∞–∫–∞–∑ —É–∂–µ –æ—Ç–º–µ–Ω–µ–Ω`);
            waiterNotifications.showInfo('–ó–∞–∫–∞–∑ —É–∂–µ –æ—Ç–º–µ–Ω–µ–Ω');
            return;
        } else {
            console.error(`‚ùå –ü–µ—Ä–µ—Ö–æ–¥ –∫ completed –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ "${cleanStatus}"`);
            const currentStatusName = getStatusName(cleanStatus);
            const targetStatusName = getStatusName('completed');
            waiterNotifications.showError(`–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ —Å "${currentStatusName}" –Ω–∞ "${targetStatusName}"`);
            return;
        }
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        console.log(`üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å: —Å—Ç–∞—Ç—É—Å ${newStatus} –¥–ª—è –∑–∞–∫–∞–∑–∞ ${orderId}`);
        console.log(`üì¶ –î–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞:`, { status: newStatus });
        
        fetch(`/waiter/api/orders/${orderId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ status: newStatus })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                waiterNotifications.showSuccess(`–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ "${newStatus}"`);
                loadOrders(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
            } else {
                waiterNotifications.showError(data.message || '–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
            }
        })
        .catch(error => {
            console.error('Error updating order status:', error);
            waiterNotifications.showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞ —Å—Ç–∞—Ç—É—Å–∞
    function canTransitionTo(currentStatus, targetStatus) {
        if (!statusReference[currentStatus]) {
            console.warn(`‚ö†Ô∏è –°—Ç–∞—Ç—É—Å "${currentStatus}" –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ`);
            return false;
        }
        
        const allowedTransitions = statusReference[currentStatus].can_transition_to || [];
        const canTransition = allowedTransitions.includes(targetStatus);
        
        console.log(`üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞: ${currentStatus} ‚Üí ${targetStatus}`);
        console.log(`üìã –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã:`, allowedTransitions);
        console.log(`‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç:`, canTransition);
        
        return canTransition;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
    function getStatusName(statusCode) {
        if (statusReference[statusCode] && statusReference[statusCode].name) {
            return statusReference[statusCode].name;
        }
        // Fallback –Ω–∞–∑–≤–∞–Ω–∏—è
        const fallbackNames = {
            'pending': '–ù–æ–≤—ã–π –∑–∞–∫–∞–∑',
            'confirmed': '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω',
            'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω',
            'cancelled': '–û—Ç–º–µ–Ω–µ–Ω'
        };
        return fallbackNames[statusCode] || statusCode;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–º–µ–Ω—ã –∑–∞–∫–∞–∑–∞
    function cancelOrder(orderId) {
        console.log(`‚ùå –û—Ç–º–µ–Ω–∞ –∑–∞–∫–∞–∑–∞ ${orderId}`);
        
        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç–º–µ–Ω—ã
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑? –ó–∞–∫–∞–∑ –±—É–¥–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω.')) {
            return;
        }
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ—Ç–º–µ–Ω—É
        fetch(`/waiter/api/orders/${orderId}/cancel`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                waiterNotifications.showSuccess('–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ç–º–µ–Ω–µ–Ω');
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤
                loadOrders();
            } else {
                waiterNotifications.showError(data.message || '–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –∑–∞–∫–∞–∑–∞');
            }
        })
        .catch(error => {
            console.error('Error cancelling order:', error);
            waiterNotifications.showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–∞
    function viewOrderDetails(orderId) {
        console.log(`üîç –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞ #${orderId}`);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞
        fetch(`/waiter/api/orders/${orderId}`)
            .then(response => {
                console.log(`üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${response.status} ${response.statusText}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('üì¶ –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', data);
                if (data.status === 'success') {
                    displayOrderDetails(data.data.order);
                } else {
                    waiterNotifications.showError(data.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–∞');
                }
            })
            .catch(error => {
                console.error('‚ùå Error loading order details:', error);
                waiterNotifications.showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            });
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–∞
    function displayOrderDetails(order) {
        console.log('üé® –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞:', order);
        
        const modal = document.getElementById('orderDetailModal');
        const content = document.getElementById('orderDetailContent');
        const printButton = document.getElementById('printOrderReceipts');
        const finalReceiptButton = document.getElementById('printFinalReceipt');
        
        console.log('üîç –ù–∞–π–¥–µ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã:', {
            modal: modal,
            content: content,
            printButton: printButton,
            finalReceiptButton: finalReceiptButton
        });
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞–π–¥–µ–Ω—ã
        if (!modal) {
            console.error('‚ùå –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!');
            waiterNotifications.showError('–û—à–∏–±–∫–∞: –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
            return;
        }
        
        if (!content) {
            console.error('‚ùå –ö–æ–Ω—Ç–µ–Ω—Ç –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω!');
            waiterNotifications.showError('–û—à–∏–±–∫–∞: –∫–æ–Ω—Ç–µ–Ω—Ç –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        
        // –†–∞–∑–¥–µ–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ –ø–æ —Ç–∏–ø–∞–º
        const kitchenItems = order.items.filter(item => item.preparation_type === 'kitchen');
        const barItems = order.items.filter(item => item.preparation_type === 'bar');
        
        let itemsHtml = '';
        
        if (kitchenItems.length > 0) {
            itemsHtml += '<div class="items-section"><h4>üçΩÔ∏è –ö–£–•–ù–Ø</h4>';
            kitchenItems.forEach(item => {
                itemsHtml += `
                    <div class="order-item">
                        <span class="item-quantity">${item.quantity}x</span>
                        <span class="item-name">${item.name}</span>
                        <span class="item-price">${item.unit_price} TMT</span>
                        ${item.comments ? `<div class="item-comments">üí¨ ${item.comments}</div>` : ''}
                    </div>
                `;
            });
            itemsHtml += '</div>';
        }
        
        if (barItems.length > 0) {
            itemsHtml += '<div class="items-section"><h4>üçπ –ë–ê–†</h4>';
            barItems.forEach(item => {
                itemsHtml += `
                    <div class="order-item">
                        <span class="item-quantity">${item.quantity}x</span>
                        <span class="item-name">${item.name}</span>
                        <span class="item-price">${item.unit_price} TMT</span>
                        ${item.comments ? `<div class="item-comments">üí¨ ${item.comments}</div>` : ''}
                    </div>
                `;
            });
            itemsHtml += '</div>';
        }
        
        content.innerHTML = `
            <div class="order-details">
                <div class="order-summary">
                    <div class="summary-item">
                        <strong>–ó–∞–∫–∞–∑ #${order.id}</strong>
                        <span class="status-badge ${order.status}">${order.status}</span>
                    </div>
                    <div class="summary-item">
                        <strong>–°—Ç–æ–ª:</strong> ${order.table_number}
                    </div>
                    <div class="summary-item">
                        <strong>–ì–æ—Å—Ç–µ–π:</strong> ${order.guest_count}
                    </div>
                    <div class="summary-item">
                        <strong>–í—Ä–µ–º—è:</strong> ${new Date(order.created_at).toLocaleTimeString()}
                    </div>
                    ${order.bonus_card ? `
                    <div class="summary-item bonus-card-info">
                        <strong>–ë–æ–Ω—É—Å–Ω–∞—è –∫–∞—Ä—Ç–∞:</strong> 
                        <span class="bonus-card-number">${order.bonus_card.card_number}</span>
                        <span class="bonus-card-discount">(${order.bonus_card.discount_percent}% —Å–∫–∏–¥–∫–∞)</span>
                    </div>
                    ` : ''}
                </div>
                
                <div class="order-items">
                    ${itemsHtml}
                </div>
                
                <div class="order-total">
                    <div class="total-item">
                        <strong>–ü–æ–¥—ã—Ç–æ–≥:</strong> ${order.subtotal} TMT
                    </div>
                    ${order.discount_amount > 0 ? `
                    <div class="total-item discount-item">
                        <strong>–°–∫–∏–¥–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ:</strong> -${order.discount_amount} TMT
                    </div>
                    ` : ''}
                    <div class="total-item">
                        <strong>–°–µ—Ä–≤–∏—Å–Ω—ã–π —Å–±–æ—Ä:</strong> ${order.service_charge} TMT
                    </div>
                    <div class="total-item total-final">
                        <strong>–ò–¢–û–ì–û:</strong> ${order.total_amount} TMT
                    </div>
                </div>
            </div>
        `;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
        const applyBonusCardButton = document.getElementById('applyBonusCard');
        
        if (order.status === '–Ω–æ–≤—ã–π') {
            printButton.style.display = 'inline-block';
            finalReceiptButton.style.display = 'none';
            applyBonusCardButton.style.display = 'inline-block';
        } else if (order.status === '–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω') {
            printButton.style.display = 'none';
            finalReceiptButton.style.display = 'inline-block';
            applyBonusCardButton.style.display = 'none';
        } else {
            printButton.style.display = 'none';
            finalReceiptButton.style.display = 'none';
            applyBonusCardButton.style.display = 'none';
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –∑–∞–∫–∞–∑–∞ –¥–ª—è –∫–Ω–æ–ø–æ–∫
        modal.dataset.orderId = order.id;
        
        console.log('üìã –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–π HTML:', content.innerHTML);
        console.log('üéØ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        modal.classList.add('visible');
        modal.classList.remove('hidden');
        
        console.log('‚úÖ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤–∏–¥–∏–º—ã–º');
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–µ—á–∞—Ç–∏ —á–µ–∫–æ–≤ –∑–∞–∫–∞–∑–∞ (–¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞)
    function printOrderReceipts() {
        const modal = document.getElementById('orderDetailModal');
        const orderId = modal.dataset.orderId;
        
        if (!orderId) {
            waiterNotifications.showError('ID –∑–∞–∫–∞–∑–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const printButton = document.getElementById('printOrderReceipts');
        const originalText = printButton.textContent;
        printButton.textContent = '–ü–µ—á–∞—Ç—å...';
        printButton.disabled = true;
        
        fetch(`/waiter/api/orders/${orderId}/print`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showPrintStatus(data.data);
                waiterNotifications.showSuccess('–ß–µ–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ –ø–µ—á–∞—Ç—å!');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
                const statusBadge = document.querySelector('.status-badge');
                if (statusBadge) {
                    statusBadge.textContent = '–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω';
                    statusBadge.className = 'status-badge –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω';
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —á–µ–∫–∞
                document.getElementById('printFinalReceipt').style.display = 'inline-block';
                printButton.style.display = 'none';
            } else {
                waiterNotifications.showError(data.message || '–û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏');
            }
        })
        .catch(error => {
            console.error('Error printing receipts:', error);
            waiterNotifications.showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
        })
        .finally(() => {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            printButton.textContent = originalText;
            printButton.disabled = false;
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –±–æ–Ω—É—Å–Ω–æ–π –∫–∞—Ä—Ç—ã
    function applyBonusCard() {
        const modal = document.getElementById('orderDetailModal');
        const orderId = modal.dataset.orderId;
        
        if (!orderId) {
            waiterNotifications.showError('ID –∑–∞–∫–∞–∑–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã
        const cardNumber = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –±–æ–Ω—É—Å–Ω–æ–π –∫–∞—Ä—Ç—ã (6 —Ü–∏—Ñ—Ä):');
        
        if (!cardNumber) {
            return;
        }
        
        if (cardNumber.length !== 6 || !/^\d+$/.test(cardNumber)) {
            waiterNotifications.showError('–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 6 —Ü–∏—Ñ—Ä');
            return;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const applyButton = document.getElementById('applyBonusCard');
        const originalText = applyButton.textContent;
        applyButton.textContent = '–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ...';
        applyButton.disabled = true;
        
        fetch(`/api/bonus-cards/apply/${orderId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                card_number: cardNumber
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                waiterNotifications.showSuccess(data.message);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞
                loadOrderDetails(orderId);
            } else {
                waiterNotifications.showError(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∫–∞—Ä—Ç—ã');
            }
        })
        .catch(error => {
            console.error('Error applying bonus card:', error);
            waiterNotifications.showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
        })
        .finally(() => {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            applyButton.textContent = originalText;
            applyButton.disabled = false;
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–µ—á–∞—Ç–∏ —á–µ–∫–æ–≤ –∑–∞–∫–∞–∑–∞ (–¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ –∑–∞–∫–∞–∑–∞)
    function printOrderReceiptsFromCard(orderId) {
        console.log(`üñ®Ô∏è –ü–µ—á–∞—Ç—å —á–µ–∫–æ–≤ –¥–ª—è –∑–∞–∫–∞–∑–∞ ${orderId}`);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const printButton = event.target;
        const originalText = printButton.innerHTML;
        printButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ü–µ—á–∞—Ç—å...';
        printButton.disabled = true;
        
        fetch(`/waiter/api/orders/${orderId}/print`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                waiterNotifications.showSuccess('–ß–µ–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ –ø–µ—á–∞—Ç—å!');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –Ω–∞ "confirmed"
                const orderCard = document.querySelector(`[data-order-id="${orderId}"]`);
                if (orderCard) {
                    const statusElement = orderCard.querySelector('.order-status');
                    if (statusElement) {
                        const statusInfo = statusReference['confirmed'];
                        if (statusInfo) {
                            statusElement.textContent = `${statusInfo.icon} ${statusInfo.name.toUpperCase()}`;
                            statusElement.style.background = statusInfo.color;
                        } else {
                            // Fallback –µ—Å–ª–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
                            const statusIcon = getStatusIcon('confirmed');
                            const statusColor = getStatusColor('confirmed');
                            statusElement.textContent = `${statusIcon} CONFIRMED`;
                            statusElement.style.background = statusColor;
                        }
                        statusElement.className = 'order-status confirmed';
                    }
                }
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤
                loadOrders();
            } else {
                waiterNotifications.showError(data.message || '–û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏');
            }
        })
        .catch(error => {
            console.error('Error printing receipts:', error);
            waiterNotifications.showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
        })
        .finally(() => {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            printButton.innerHTML = originalText;
            printButton.disabled = false;
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–µ—á–∞—Ç–∏ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —á–µ–∫–∞
    function printFinalReceipt() {
        const modal = document.getElementById('orderDetailModal');
        const orderId = modal.dataset.orderId;
        
        if (!orderId) {
            waiterNotifications.showError('ID –∑–∞–∫–∞–∑–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const printButton = document.getElementById('printFinalReceipt');
        const originalText = printButton.textContent;
        printButton.textContent = '–ü–µ—á–∞—Ç—å...';
        printButton.disabled = true;
        
        fetch(`/waiter/api/orders/${orderId}/print-final`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                waiterNotifications.showSuccess('–§–∏–Ω–∞–ª—å–Ω—ã–π —á–µ–∫ –Ω–∞–ø–µ—á–∞—Ç–∞–Ω!');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
                const statusBadge = document.querySelector('.status-badge');
                if (statusBadge) {
                    statusBadge.textContent = '–∑–∞–≤–µ—Ä—à–µ–Ω';
                    statusBadge.className = 'status-badge –∑–∞–≤–µ—Ä—à–µ–Ω';
                }
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–µ—á–∞—Ç–∏
                printButton.style.display = 'none';
            } else {
                waiterNotifications.showError(data.message || '–û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —á–µ–∫–∞');
            }
        })
        .catch(error => {
            console.error('Error printing final receipt:', error);
            waiterNotifications.showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
        })
        .finally(() => {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            printButton.textContent = originalText;
            printButton.disabled = false;
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–µ—á–∞—Ç–∏
    function showPrintStatus(printData) {
        const modal = document.getElementById('printStatusModal');
        const content = document.getElementById('printStatusContent');
        
        let statusHtml = '<div class="print-status">';
        
        if (printData.kitchen_printed) {
            statusHtml += '<div class="status-item success">‚úÖ –ö—É—Ö–æ–Ω–Ω—ã–π —á–µ–∫ –Ω–∞–ø–µ—á–∞—Ç–∞–Ω</div>';
        } else {
            statusHtml += '<div class="status-item error">‚ùå –û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏ –∫—É—Ö–æ–Ω–Ω–æ–≥–æ —á–µ–∫–∞</div>';
        }
        
        if (printData.bar_printed) {
            statusHtml += '<div class="status-item success">‚úÖ –ë–∞—Ä–Ω—ã–π —á–µ–∫ –Ω–∞–ø–µ—á–∞—Ç–∞–Ω</div>';
        } else {
            statusHtml += '<div class="status-item error">‚ùå –û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏ –±–∞—Ä–Ω–æ–≥–æ —á–µ–∫–∞</div>';
        }
        
        statusHtml += `<div class="status-summary">
            <p>–ö—É—Ö–æ–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π: ${printData.kitchen_items_count}</p>
            <p>–ë–∞—Ä–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π: ${printData.bar_items_count}</p>
        </div>`;
        
        statusHtml += '</div>';
        content.innerHTML = statusHtml;
        
        modal.style.display = 'block';
    }
    
    // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å
    window.updateOrderStatus = updateOrderStatus;
    window.viewOrderDetails = viewOrderDetails;
    window.printOrderReceipts = printOrderReceipts;
    window.printOrderReceiptsFromCard = printOrderReceiptsFromCard;
    window.printFinalReceipt = printFinalReceipt;
    window.applyBonusCard = applyBonusCard;
    window.cancelOrder = cancelOrder;

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    document.getElementById('refreshOrders').addEventListener('click', loadOrders);
    document.getElementById('statusFilter').addEventListener('change', loadOrders);
    document.getElementById('tableFilter').addEventListener('change', loadOrders);
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–µ—á–∞—Ç–∏
    document.getElementById('printOrderReceipts').addEventListener('click', printOrderReceipts);
    document.getElementById('printFinalReceipt').addEventListener('click', printFinalReceipt);
    document.getElementById('applyBonusCard').addEventListener('click', applyBonusCard);
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
    document.querySelectorAll('[data-dismiss="modal"]').forEach(button => {
        button.addEventListener('click', function() {
            console.log('üîí –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ');
            const modal = this.closest('.modal');
            if (modal) {
                modal.classList.remove('visible');
                modal.classList.add('hidden');
            }
        });
    });
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                console.log('üîí –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ');
                this.classList.remove('visible');
                this.classList.add('hidden');
            }
        });
    });
    
    // –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
    loadOrders();
});
</script>
{% endblock %}