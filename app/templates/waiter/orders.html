{% extends "waiter/base.html" %}

{% block title %}–ó–∞–∫–∞–∑—ã - –û—Ñ–∏—Ü–∏–∞–Ω—Ç - DENIZ Restaurant{% endblock %}

{% block content %}
<div class="orders-container">
    <div class="page-header">
        <h1>–ó–∞–∫–∞–∑—ã</h1>
        <div class="header-actions">
            <button class="btn btn-secondary" id="refreshOrders">
                <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
            </button>
        </div>
    </div>

    <div class="orders-filters">
        <div class="filter-group">
            <label>–°—Ç–∞—Ç—É—Å:</label>
            <select id="statusFilter" class="form-control">
                <option value="">–í—Å–µ</option>
                <option value="–Ω–æ–≤—ã–π">–ù–æ–≤—ã–µ</option>
                <option value="–æ–ø–ª–∞—á–µ–Ω">–û–ø–ª–∞—á–µ–Ω–Ω—ã–µ</option>
            </select>
        </div>
        <div class="filter-group">
            <label>–°—Ç–æ–ª:</label>
            <select id="tableFilter" class="form-control">
                <option value="">–í—Å–µ —Å—Ç–æ–ª—ã</option>
            </select>
        </div>
    </div>

    <div class="orders-list" id="ordersList">
        <div class="loading-placeholder">
            <div class="spinner"></div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</p>
        </div>
    </div>

    <!-- Order Detail Modal -->
    <div class="modal modal-overlay" id="orderDetailModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞</h3>
                <button type="button" class="btn-close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body" id="orderDetailContent">
                <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button type="button" class="btn btn-primary" id="updateOrderStatus">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìã Orders page initialized');
    
    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤
    async function loadOrders() {
        try {
            const statusFilter = document.getElementById('statusFilter').value;
            const tableFilter = document.getElementById('tableFilter').value;
            
            const filters = {};
            if (statusFilter) filters.status = statusFilter;
            if (tableFilter) filters.table_id = tableFilter;
            
            const ordersList = document.getElementById('ordersList');
            ordersList.innerHTML = '<div class="loading-placeholder"><div class="spinner"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</p></div>';
            
            // –ü–æ–ª—É—á–∞–µ–º –∑–∞–∫–∞–∑—ã —á–µ—Ä–µ–∑ API
            const response = await window.WaiterAPI.getOrders(filters);
            
            if (response.status === 'success' && response.data.orders.length > 0) {
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∑–∞–∫–∞–∑—ã
                let ordersHtml = '';
                response.data.orders.forEach(order => {
                    const statusColor = WaiterUtils.getOrderStatusColor(order.status);
                    const statusIcon = WaiterUtils.getOrderStatusIcon(order.status);
                    
                    ordersHtml += `
                        <div class="order-card" data-order-id="${order.id}">
                            <div class="order-header">
                                <div class="order-info">
                                    <div class="order-title">
                                        <h3>–ó–∞–∫–∞–∑ #${order.id}</h3>
                                        <span class="order-status" style="background: ${statusColor};">
                                            ${order.status}
                                        </span>
                                    </div>
                                    <div class="order-table-info">
                                        <i class="fas fa-table"></i>
                                        <span>–°—Ç–æ–ª: ${order.table_number}</span>
                                        <i class="fas fa-users"></i>
                                        <span>–ì–æ—Å—Ç–µ–π: ${order.guest_count}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="order-body">
                                <div class="order-total">
                                    <div class="total-label">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</div>
                                    <div class="total-amount">${order.total_amount} ‚ÇΩ</div>
                                </div>
                                <div class="order-meta">
                                    <div class="meta-item">
                                        <i class="fas fa-clock"></i>
                                        <span>–°–æ–∑–¥–∞–Ω: ${new Date(order.created_at).toLocaleString('ru-RU')}</span>
                                    </div>
                                    <div class="meta-item">
                                        <i class="fas fa-language"></i>
                                        <span>–Ø–∑—ã–∫: ${order.language.toUpperCase()}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="order-actions">
                                <button class="btn btn-primary" onclick="viewOrderDetails(${order.id})">
                                    <i class="fas fa-eye"></i> –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏
                                </button>
                                <button class="btn ${order.status === '–Ω–æ–≤—ã–π' ? 'btn-success' : 'btn-secondary'}" 
                                        onclick="${order.status === '–Ω–æ–≤—ã–π' ? `updateOrderStatus(${order.id})` : ''}"
                                        ${order.status === '–æ–ø–ª–∞—á–µ–Ω' ? 'disabled' : ''}>
                                    <i class="fas fa-check"></i> ${order.status === '–Ω–æ–≤—ã–π' ? '–û—Ç–º–µ—Ç–∏—Ç—å –æ–ø–ª–∞—á–µ–Ω–Ω—ã–º' : '–ó–∞–∫–∞–∑ –æ–ø–ª–∞—á–µ–Ω'}
                                </button>
                            </div>
                        </div>
                    `;
                });
                ordersList.innerHTML = ordersHtml;
            } else {
                // –ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤
                ordersList.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-clipboard-list"></i>
                        <h3>–ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                        <p>–í –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∏–ª—å—Ç—Ä–∞–º</p>
                    </div>
                `;
            }
            
        } catch (error) {
            console.error('Error loading orders:', error);
            waiterNotifications.showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤');
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞
    function updateOrderStatus(orderId) {
        // –ù–∞—Ö–æ–¥–∏–º –∑–∞–∫–∞–∑ –≤ —Å–ø–∏—Å–∫–µ
        const orderCards = document.querySelectorAll('.order-card');
        let currentOrder = null;
        
        orderCards.forEach(card => {
            if (card.dataset.orderId == orderId) {
                currentOrder = card;
            }
        });
        
        if (!currentOrder) {
            waiterNotifications.showError('–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –∏–∑ DOM
        const statusElement = currentOrder.querySelector('.order-status');
        const currentStatus = statusElement.textContent.trim();
        
        let newStatus;
        let actionText;
        
        if (currentStatus === '–Ω–æ–≤—ã–π') {
            newStatus = '–æ–ø–ª–∞—á–µ–Ω';
            actionText = '–æ—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–π';
        } else if (currentStatus === '–æ–ø–ª–∞—á–µ–Ω') {
            waiterNotifications.showInfo('–ó–∞–∫–∞–∑ —É–∂–µ –æ–ø–ª–∞—á–µ–Ω');
            return;
        } else {
            waiterNotifications.showError('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞');
            return;
        }
        
        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è
        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${actionText}?`)) {
            return;
        }
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        fetch(`/waiter/api/orders/${orderId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: newStatus })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                waiterNotifications.showSuccess(`–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ "${newStatus}"`);
                loadOrders(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
            } else {
                waiterNotifications.showError(data.message || '–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
            }
        })
        .catch(error => {
            console.error('Error updating order status:', error);
            waiterNotifications.showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–∞
    function viewOrderDetails(orderId) {
        waiterNotifications.showInfo(`–û—Ç–∫—Ä—ã—Ç–∏–µ –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–∞ #${orderId} (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)`);
    }
    
    // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏
    window.updateOrderStatus = updateOrderStatus;
    window.viewOrderDetails = viewOrderDetails;

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    document.getElementById('refreshOrders').addEventListener('click', loadOrders);
    document.getElementById('statusFilter').addEventListener('change', loadOrders);
    document.getElementById('tableFilter').addEventListener('change', loadOrders);
    
    // –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
    loadOrders();
});
</script>
{% endblock %}