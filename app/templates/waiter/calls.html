{% extends "waiter/base.html" %}

{% block title %}–í—ã–∑–æ–≤—ã - –û—Ñ–∏—Ü–∏–∞–Ω—Ç - DENIZ Restaurant{% endblock %}

{% block content %}
<div class="calls-container">
    <div class="page-header">
        <h1>–í—ã–∑–æ–≤—ã –æ—Ñ–∏—Ü–∏–∞–Ω—Ç–∞</h1>
        <div class="header-actions">
            <button class="btn btn-secondary" id="refreshCalls">
                <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
            </button>
            <button class="btn btn-success" id="markAllRead">
                <i class="fas fa-check-double"></i> –û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
            </button>
        </div>
    </div>

    <div class="calls-filters">
        <div class="filter-group">
            <label>–°—Ç–∞—Ç—É—Å:</label>
            <select id="statusFilter" class="form-control">
                <option value="">–í—Å–µ</option>
                <option value="–Ω–æ–≤—ã–π">–ù–æ–≤—ã–µ</option>
                <option value="–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
                <option value="–≤—ã–ø–æ–ª–Ω–µ–Ω">–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</option>
            </select>
        </div>
        <div class="filter-group">
            <label>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</label>
            <select id="priorityFilter" class="form-control">
                <option value="">–í—Å–µ</option>
                <option value="–≤—ã—Å–æ–∫–∏–π">–í—ã—Å–æ–∫–∏–π</option>
                <option value="—Å—Ä–µ–¥–Ω–∏–π">–°—Ä–µ–¥–Ω–∏–π</option>
                <option value="–Ω–∏–∑–∫–∏–π">–ù–∏–∑–∫–∏–π</option>
            </select>
        </div>
    </div>

    <div class="calls-list" id="callsList">
        <div class="loading-placeholder">
            <div class="spinner"></div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –≤—ã–∑–æ–≤–æ–≤...</p>
        </div>
    </div>

    <!-- Call Response Modal -->
    <div class="modal modal-overlay" id="callResponseModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–û—Ç–≤–µ—Ç –Ω–∞ –≤—ã–∑–æ–≤</h3>
                <button type="button" class="btn-close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="call-info" id="callInfo">
                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–∑–æ–≤–µ -->
                </div>
                <div class="response-form">
                    <div class="form-group">
                        <label>–î–µ–π—Å—Ç–≤–∏–µ:</label>
                        <select id="responseAction" class="form-control">
                            <option value="–ø—Ä–∏–Ω—è—Ç">–ü—Ä–∏–Ω—è—Ç—å –≤—ã–∑–æ–≤</option>
                            <option value="–≤—ã–ø–æ–ª–Ω–µ–Ω">–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–π</option>
                            <option value="–æ—Ç–∫–ª–æ–Ω–µ–Ω">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
                        <textarea id="responseComment" class="form-control" rows="3" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" id="submitResponse">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîî Calls page initialized');
    
    let currentCallId = null;
    
    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤—ã–∑–æ–≤–æ–≤
    async function loadCalls() {
        try {
            const statusFilter = document.getElementById('statusFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;
            
            const filters = {};
            if (statusFilter) filters.status = statusFilter;
            if (priorityFilter) filters.priority = priorityFilter;
            
            const callsList = document.getElementById('callsList');
            callsList.innerHTML = '<div class="loading-placeholder"><div class="spinner"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞ –≤—ã–∑–æ–≤–æ–≤...</p></div>';
            
            // –ü–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É
            setTimeout(() => {
                const sampleCalls = [
                    { 
                        id: 1, 
                        table_number: 5, 
                        message: '–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å —Å –º–µ–Ω—é', 
                        status: '–Ω–æ–≤—ã–π', 
                        priority: '—Å—Ä–µ–¥–Ω–∏–π',
                        created_at: new Date(Date.now() - 5 * 60000),
                        customer_name: '–ö–ª–∏–µ–Ω—Ç —Å—Ç–æ–ª–∞ 5'
                    },
                    { 
                        id: 2, 
                        table_number: 12, 
                        message: '–°—á–µ—Ç, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞', 
                        status: '–Ω–æ–≤—ã–π', 
                        priority: '–≤—ã—Å–æ–∫–∏–π',
                        created_at: new Date(Date.now() - 2 * 60000),
                        customer_name: '–ö–ª–∏–µ–Ω—Ç —Å—Ç–æ–ª–∞ 12'
                    },
                    { 
                        id: 3, 
                        table_number: 3, 
                        message: '–ó–∞–∫–∞–∑ –≥–æ—Ç–æ–≤ –∫ –ø–æ–¥–∞—á–µ', 
                        status: '–≤—ã–ø–æ–ª–Ω–µ–Ω', 
                        priority: '–≤—ã—Å–æ–∫–∏–π',
                        created_at: new Date(Date.now() - 15 * 60000),
                        customer_name: '–ö—É—Ö–Ω—è'
                    }
                ];
                
                let filteredCalls = sampleCalls;
                if (statusFilter) {
                    filteredCalls = filteredCalls.filter(c => c.status === statusFilter);
                }
                if (priorityFilter) {
                    filteredCalls = filteredCalls.filter(c => c.priority === priorityFilter);
                }
                
                if (filteredCalls.length === 0) {
                    callsList.innerHTML = `
                        <div class="no-data">
                            <i class="fas fa-bell-slash"></i>
                            <h3>–í—ã–∑–æ–≤—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                            <p>–ù–µ—Ç –≤—ã–∑–æ–≤–æ–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º</p>
                        </div>
                    `;
                    return;
                }
                
                const callsHtml = filteredCalls.map(call => `
                    <div class="call-card call-${call.status} priority-${call.priority}" data-call-id="${call.id}">
                        <div class="call-header">
                            <div class="call-table">
                                <i class="fas fa-utensils"></i>
                                –°—Ç–æ–ª ${call.table_number}
                            </div>
                            <div class="call-time">
                                ${WaiterUtils.formatTime(call.created_at)}
                            </div>
                            <div class="call-priority priority-${call.priority}">
                                ${getPriorityText(call.priority)}
                            </div>
                        </div>
                        <div class="call-content">
                            <div class="call-message">${call.message}</div>
                            <div class="call-from">–û—Ç: ${call.customer_name}</div>
                        </div>
                        <div class="call-status">
                            <span class="status-badge status-${call.status}">
                                ${getStatusText(call.status)}
                            </span>
                        </div>
                        <div class="call-actions">
                            ${call.status === '–Ω–æ–≤—ã–π' ? `
                                <button class="btn btn-sm btn-primary" onclick="respondToCall(${call.id})">
                                    –û—Ç–≤–µ—Ç–∏—Ç—å
                                </button>
                            ` : ''}
                            <button class="btn btn-sm btn-secondary" onclick="showCallDetails(${call.id})">
                                –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                            </button>
                        </div>
                    </div>
                `).join('');
                
                callsList.innerHTML = callsHtml;
            }, 1000);
            
        } catch (error) {
            console.error('Error loading calls:', error);
            waiterNotifications.showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—ã–∑–æ–≤–æ–≤');
        }
    }
    
    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function getStatusText(status) {
        const statusTexts = {
            '–Ω–æ–≤—ã–π': '–ù–æ–≤—ã–π',
            '–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è': '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ',
            '–≤—ã–ø–æ–ª–Ω–µ–Ω': '–í—ã–ø–æ–ª–Ω–µ–Ω'
        };
        return statusTexts[status] || status;
    }
    
    function getPriorityText(priority) {
        const priorityTexts = {
            '–≤—ã—Å–æ–∫–∏–π': '–í—ã—Å–æ–∫–∏–π',
            '—Å—Ä–µ–¥–Ω–∏–π': '–°—Ä–µ–¥–Ω–∏–π',
            '–Ω–∏–∑–∫–∏–π': '–ù–∏–∑–∫–∏–π'
        };
        return priorityTexts[priority] || priority;
    }
    
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    window.respondToCall = function(callId) {
        currentCallId = callId;
        console.log('Responding to call:', callId);
        
        document.getElementById('callInfo').innerHTML = `
            <div class="call-summary">
                <h4>–í—ã–∑–æ–≤ –æ—Ç —Å—Ç–æ–ª–∞ ${callId}</h4>
                <p>–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤—ã–∑–æ–≤...</p>
            </div>
        `;
        
        waiterModals.show('callResponseModal');
    };
    
    window.showCallDetails = function(callId) {
        console.log('Showing call details:', callId);
        waiterNotifications.showInfo(`–î–µ—Ç–∞–ª–∏ –≤—ã–∑–æ–≤–∞ ${callId} (—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)`);
    };
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞
    document.getElementById('submitResponse').addEventListener('click', async function() {
        if (!currentCallId) return;
        
        const action = document.getElementById('responseAction').value;
        const comment = document.getElementById('responseComment').value;
        
        try {
            // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –≤—ã–∑–æ–≤ API
            console.log('Submitting response:', { callId: currentCallId, action, comment });
            
            waiterNotifications.showSuccess('–û—Ç–≤–µ—Ç –Ω–∞ –≤—ã–∑–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
            waiterModals.hide(document.getElementById('callResponseModal'));
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
            loadCalls();
            
        } catch (error) {
            console.error('Error submitting response:', error);
            waiterNotifications.showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–≤–µ—Ç–∞');
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    document.getElementById('refreshCalls').addEventListener('click', loadCalls);
    document.getElementById('statusFilter').addEventListener('change', loadCalls);
    document.getElementById('priorityFilter').addEventListener('change', loadCalls);
    
    document.getElementById('markAllRead').addEventListener('click', function() {
        waiterNotifications.showSuccess('–í—Å–µ –≤—ã–∑–æ–≤—ã –æ—Ç–º–µ—á–µ–Ω—ã –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ');
        loadCalls();
    });
    
    // –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
    loadCalls();
    
    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    setInterval(loadCalls, 30000);
});
</script>

{% endblock %}